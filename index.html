<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026í•™ë…„ë„ KIS 10í•™ë…„ ì•Œë¦¼ì´</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- PWA ë©”íƒ€íƒœê·¸ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="2026í•™ë…„ë„ KIS 10í•™ë…„ ì•Œë¦¼ì´">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="2026í•™ë…„ë„ KIS 10í•™ë…„ ì•Œë¦¼ì´">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="theme-color" content="#667eea">

    <!-- iOS ì•„ì´ì½˜ -->
    <link rel="apple-touch-icon"
        href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjNjY3ZWVhIiByeD0iMjAiLz4KPHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeD0iNDAiIHk9IjQwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KICA8cGF0aCBkPSJNMTIgM0M2LjQ4IDMgMiA2LjQ4IDIgMTJzNC40OCA5IDkgOSA5LTQuNDggOS05LTQuNDgtOS05LTl6bS0yIDE1LjVWNi41bDYgNi02IDZ6Ii8+Cjwvc3ZnPgo8L3N2Zz4K">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNjY3ZWVhIiByeD0iNCIvPgo8c3ZnIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgeD0iNiIgeT0iNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CiAgPHBhdGggZD0iTTEyIDNDNi40OCAzIDIgNi40OCAyIDEyczQuNDggOSA5IDkgOS00LjQ4IDktOS00LjQ4LTktOS05em0tMiAxNS41VjYuNWw2IDYtNiA2eiIvPgo8L3N2Zz4KPC9zdmc+">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* í—¤ë” */
        .header {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border-radius: 15px;
        }

        .header-content {
            text-align: center;
            animation: fadeInDown 0.8s ease-out;
        }

        .header-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #718096;
            font-weight: 400;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* ì„¹ì…˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: fadeInUp 0.6s ease-out;
        }

        .section-title {
            font-size: 1.8rem;
            color: #2d3748;
            margin-bottom: 25px;
            font-weight: 600;
            border-left: 4px solid #667eea;
            padding-left: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Noto Sans KR', sans-serif;
            transition: all 0.3s ease;
            background: #fafafa;
            box-sizing: border-box;
        }

        select {
            padding-right: 45px;
            /* ë“œë¡­ë‹¤ìš´ í™”ì‚´í‘œ ê³µê°„ í™•ë³´ */
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23667eea'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        /* ê³µì§€ì‚¬í•­ ì¹´ë“œ */
        .announcement-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            position: relative;
        }

        .announcement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .announcement-card.urgent {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .announcement-card.urgent::before {
            content: "ğŸš¨";
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.2rem;
        }

        .announcement-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .announcement-content {
            color: #4a5568;
            margin-bottom: 15px;
            line-height: 1.7;
        }

        .announcement-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #718096;
            flex-wrap: wrap;
            gap: 10px;
        }

        .announcement-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* ëŒ“ê¸€ ì„¹ì…˜ */
        .comments-section {
            margin-top: 20px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }

        .comment-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .comment-author {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .comment-content {
            color: #4a5568;
            margin-bottom: 5px;
        }

        .comment-time {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .calendar-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-nav button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            padding: 1px;
        }

        .calendar-day-header {
            background: #f3f4f6;
            padding: 12px 8px;
            text-align: center;
            font-weight: 500;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid #f3f4f6;
        }

        .calendar-day:hover {
            background: #f9fafb;
        }

        /* í† ìš”ì¼ */
        .calendar-day.saturday {
            background: #f0f9ff;
        }

        .calendar-day.saturday .calendar-day-number {
            color: #0ea5e9;
            font-weight: 600;
        }

        /* ì¼ìš”ì¼ */
        .calendar-day.sunday {
            background: #fef2f2;
        }

        .calendar-day.sunday .calendar-day-number {
            color: #ef4444;
            font-weight: 600;
        }

        /* ê³µíœ´ì¼ */
        .calendar-day.holiday {
            background: #fef2f2;
        }

        .calendar-day.holiday .calendar-day-number {
            color: #dc2626;
            font-weight: 700;
        }

        /* í•™êµ í–‰ì‚¬ê°€ ìˆëŠ” ë‚  */
        .calendar-day.has-event {
            background: #ede9fe;
            border: 2px solid #8b5cf6;
        }

        .calendar-day.has-event .calendar-day-number {
            color: #7c3aed;
            font-weight: 700;
        }

        /* ì˜¤ëŠ˜ ë‚ ì§œ */
        .calendar-day.today {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .calendar-day.today .calendar-day-number {
            color: #d97706;
            font-weight: 700;
        }

        .calendar-day-number {
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        .calendar-day.other-month .calendar-day-number {
            color: #d1d5db;
        }

        .calendar-event {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            cursor: pointer;
        }

        /* ê²€ìƒ‰ ë°” */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            padding-left: 15px !important;
        }

        /* ì‚¬ìš©ì í”„ë¡œí•„ */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
            text-align: center;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* ë°°ì§€ */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-urgent {
            background: #fed7d7;
            color: #c53030;
        }

        .badge-normal {
            background: #e2e8f0;
            color: #4a5568;
        }

        .badge-approved {
            background: #c6f6d5;
            color: #2f855a;
        }

        .badge-pending {
            background: #feebc8;
            color: #dd6b20;
        }

        /* í†µê³„ ìœ„ì ¯ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #4a5568;
            font-weight: 500;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-title {
                font-size: 2rem;
            }

            .nav-tabs {
                gap: 5px;
            }

            .nav-tab {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            .form-row {
                flex-direction: column;
            }

            .announcement-meta {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ë¡œê·¸ì¸/íšŒì›ê°€ì… í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .auth-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .auth-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .auth-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .auth-form-container {
            padding: 40px 30px;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-btn {
            margin-top: 20px;
        }

        .auth-links {
            text-align: center;
            margin-top: 25px;
            color: #6b7280;
        }

        .link-btn {
            background: none;
            border: none;
            color: #667eea;
            font-weight: 500;
            cursor: pointer;
            text-decoration: underline;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .link-btn:hover {
            color: #5b67d1;
        }

        .role-fields {
            margin-top: 15px;
        }

        .role-fields .form-group:first-child {
            margin-top: 0;
        }

        /* íšŒì›ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
        .user-management-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .management-header {
            background: #f8fafc;
            padding: 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .management-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .management-filters select {
            min-width: 120px;
            padding: 8px 12px;
            padding-right: 35px;
            /* ë“œë¡­ë‹¤ìš´ í™”ì‚´í‘œ ê³µê°„ */
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23374151'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        .user-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
        }

        .user-item:hover {
            background: #f9fafb;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar-mini {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-details {
            flex: 1;
        }

        .user-name-role {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .user-meta {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-active {
            background: #10b981;
        }

        .status-pending {
            background: #f59e0b;
        }

        .status-suspended {
            background: #ef4444;
        }

        .teacher-only {
            display: none !important;
        }

        .teacher-visible .teacher-only {
            display: flex !important;
        }

        /* í˜ì´ì§• ìŠ¤íƒ€ì¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .pagination-btn:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 0 10px;
        }

        /* ê´€ë¦¬ì íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .admin-tools-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .tool-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .tool-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: 1px solid #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .system-info {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #374151;
        }

        .info-label {
            font-weight: 500;
        }

        .info-value {
            color: #667eea;
            font-family: monospace;
        }

        /* ì•Œë¦¼ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .notification-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
            margin-right: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .notification-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .badge-icon {
            font-size: 1.1rem;
            animation: swing 3s ease-in-out infinite;
        }

        .badge-count {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .badge-text {
            font-weight: 500;
        }

        .student-parent-only {
            display: none !important;
        }

        .student-visible .student-parent-only,
        .parent-visible .student-parent-only {
            display: flex !important;
        }

        /* ì•Œë¦¼ ë°°ì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes swing {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-10deg);
            }

            75% {
                transform: rotate(10deg);
            }
        }

        /* íŒŒì¼ ì²¨ë¶€ ìŠ¤íƒ€ì¼ */
        .file-attachment {
            margin: 15px 0;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #e0e7ff;
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 2rem;
            color: #9ca3af;
            margin-bottom: 10px;
        }

        .file-upload-text {
            color: #374151;
            margin-bottom: 5px;
        }

        .file-upload-hint {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-icon {
            font-size: 1.2rem;
        }

        .file-details {
            font-size: 0.9rem;
            color: #374151;
        }

        .file-size {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .file-remove {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .file-remove:hover {
            background: #fca5a5;
        }

        /* ì²¨ë¶€íŒŒì¼ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .attachments-section {
            margin: 15px 0;
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }

        .attachments-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .attachments-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .attachment-item .file-size {
            color: #9ca3af;
            margin-left: auto;
        }

        /* ë°˜ì‘í˜• í™•ì¥ */
        @media (max-width: 768px) {
            .auth-page {
                padding: 10px;
            }

            .auth-container {
                max-width: 100%;
            }

            .auth-header {
                padding: 30px 20px;
            }

            .auth-title {
                font-size: 1.5rem;
            }

            .auth-form-container {
                padding: 30px 20px;
            }

            .management-header {
                flex-direction: column;
                align-items: stretch;
            }

            .management-filters {
                justify-content: stretch;
            }

            .management-filters select {
                flex: 1;
                min-width: auto;
            }

            .user-item {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .user-info-section {
                justify-content: flex-start;
            }

            .user-actions {
                justify-content: flex-end;
            }
        }
    </style>
</head>

<body>
    <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
    <div id="loginPage" class="auth-page">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-icon">ğŸ«ğŸ“š</div>
                <h1 class="auth-title">2026í•™ë…„ë„ KIS 10í•™ë…„ ì•Œë¦¼ì´</h1>
                <p class="auth-subtitle">ğŸ‘¨â€ğŸ« êµì‚¬, ğŸ‘¨â€ğŸ“ í•™ìƒ, ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ë¶€ëª¨ê°€ í•¨ê»˜í•˜ëŠ” ì†Œí†µ ê³µê°„</p>
            </div>

            <div class="auth-form-container">
                <h2 class="form-title">ğŸ”‘ ë¡œê·¸ì¸</h2>

                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginRole">ğŸ‘¤ ì‚¬ìš©ì êµ¬ë¶„</label>
                        <select id="loginRole" required autocomplete="off">
                            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="teacher">ğŸ‘¨â€ğŸ« êµì‚¬</option>
                            <option value="student">ğŸ‘¨â€ğŸ“ í•™ìƒ</option>
                            <option value="parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ë¶€ëª¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="loginId">ğŸ†” ì•„ì´ë””</label>
                        <input type="text" id="loginId" required placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label for="loginPassword">ğŸ”’ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            autocomplete="new-password">
                    </div>

                    <button type="submit" class="btn btn-full auth-btn">
                        ğŸš€ ë¡œê·¸ì¸
                    </button>
                </form>

                <div class="auth-links">
                    <p>ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button class="link-btn" onclick="showSignup()">ğŸ‘† íšŒì›ê°€ì…</button></p>
                </div>

                <div id="loginStatus" class="status-message hidden"></div>
            </div>
        </div>
    </div>

    <!-- íšŒì›ê°€ì… í˜ì´ì§€ -->
    <div id="signupPage" class="auth-page hidden">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-icon">ğŸ“âœ¨</div>
                <h1 class="auth-title">íšŒì›ê°€ì…</h1>
                <p class="auth-subtitle">ì†Œí†µì°½êµ¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>

            <div class="auth-form-container">
                <h2 class="form-title">ğŸ‘¥ ìƒˆ ê³„ì • ë§Œë“¤ê¸°</h2>

                <form id="signupForm" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signupRole">ğŸ‘¤ ì‚¬ìš©ì êµ¬ë¶„</label>
                        <select id="signupRole" required onchange="updateSignupForm()">
                            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="student">ğŸ‘¨â€ğŸ“ í•™ìƒ</option>
                            <option value="parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ë¶€ëª¨</option>
                        </select>
                    </div>

                    <div id="studentFields" class="role-fields hidden">
                        <div class="form-group">
                            <label for="studentUserId">ğŸ†” ì•„ì´ë””</label>
                            <input type="text" id="studentUserId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>

                        <div class="form-group">
                            <label for="studentName">ğŸ‘¤ í•™ìƒ ì´ë¦„</label>
                            <input type="text" id="studentName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>

                    <div id="parentFields" class="role-fields hidden">
                        <div class="form-group">
                            <label for="parentUserId">ğŸ†” ì•„ì´ë””</label>
                            <input type="text" id="parentUserId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>

                        <div class="form-group">
                            <label for="parentName">ğŸ‘¤ í•™ë¶€ëª¨ ì´ë¦„</label>
                            <input type="text" id="parentName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="signupPassword">ğŸ”’ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="signupPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="confirmPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <button type="submit" class="btn btn-full auth-btn">
                        ğŸ‰ íšŒì›ê°€ì…
                    </button>
                </form>

                <div class="auth-links">
                    <p>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button class="link-btn" onclick="showLogin()">ğŸ‘† ë¡œê·¸ì¸</button></p>
                </div>

                <div id="signupStatus" class="status-message hidden"></div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <!-- í—¤ë” -->
            <header class="header">
                <div class="header-content">
                    <div class="header-icon">ğŸ«ğŸ“š</div>
                    <h1 class="main-title">2026í•™ë…„ë„ KIS 10í•™ë…„ ì•Œë¦¼ì´</h1>
                    <p class="subtitle">ğŸ‘¨â€ğŸ« êµì‚¬, ğŸ‘¨â€ğŸ“ í•™ìƒ, ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ë¶€ëª¨ê°€ í•¨ê»˜í•˜ëŠ” ì†Œí†µ ê³µê°„</p>
                </div>
            </header>

            <!-- ì‚¬ìš©ì í”„ë¡œí•„ -->
            <div class="user-profile" id="userProfile">
                <!-- ì•Œë¦¼ ë°°ì§€ (í•™ìƒ/í•™ë¶€ëª¨ë§Œ) -->
                <div class="notification-badge student-parent-only hidden" id="notificationBadge"
                    onclick="showNotifications()">
                    <div class="badge-icon">ğŸ””</div>
                    <div class="badge-count" id="badgeCount">0</div>
                    <div class="badge-text">ìƒˆ ì•Œë¦¼</div>
                </div>

                <div class="user-avatar" id="userAvatar">ğŸ‘¨â€ğŸ«</div>
                <div class="user-info">
                    <div class="user-name" id="userName">ë¹¨ê°„ì•„ë¹ </div>
                    <div class="user-role" id="userRole">êµì‚¬(10-2ë°˜ ë‹´ì„)</div>
                </div>
                <button class="btn btn-secondary" onclick="logout()">
                    ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
            <nav class="nav-tabs">
                <div class="nav-tab active" onclick="showSection('dashboard', this)">
                    ğŸ  ëŒ€ì‹œë³´ë“œ
                </div>
                <div class="nav-tab" onclick="showSection('announcements', this)">
                    ğŸ“¢ ê³µì§€ì‚¬í•­
                </div>
                <div class="nav-tab" onclick="showSection('calendar', this)">
                    ğŸ“… ë‹¬ë ¥
                </div>
                <div class="nav-tab" onclick="showSection('questions', this)">
                    â“ ì§ˆë¬¸/ìƒë‹´
                </div>
                <div class="nav-tab" onclick="showSection('search', this)">
                    ğŸ” ê²€ìƒ‰
                </div>
                <div class="nav-tab teacher-only hidden" onclick="showSection('users', this)">
                    ğŸ‘¥ íšŒì›ê´€ë¦¬
                </div>
                <div class="nav-tab teacher-only hidden" onclick="showSection('admin', this)">
                    âš™ï¸ ê´€ë¦¬ìíŒ¨ë„
                </div>
            </nav>

            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboard-section" class="section">
                <h2 class="section-title">
                    ğŸ“Š ëŒ€ì‹œë³´ë“œ
                </h2>

                <!-- í†µê³„ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAnnouncements">24</div>
                        <div class="stat-label">ğŸ“ ì´ ê³µì§€ì‚¬í•­</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalComments">156</div>
                        <div class="stat-label">ğŸ’¬ ì´ ëŒ“ê¸€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalQuestions">8</div>
                        <div class="stat-label">â“ ë¯¸ë‹µë³€ ì§ˆë¬¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">67</div>
                        <div class="stat-label">ğŸ‘¥ ì´ ì‚¬ìš©ì</div>
                    </div>
                </div>

                <!-- ìµœê·¼ ê³µì§€ì‚¬í•­ -->
                <h3 style="color: #2d3748; margin-bottom: 15px; font-weight: 600;">ğŸ“¢ ìµœê·¼ ê³µì§€ì‚¬í•­</h3>
                <div id="recentAnnouncements">
                    <!-- ìµœê·¼ ê³µì§€ì‚¬í•­ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>

                <!-- ê³µì§€ì‚¬í•­ í˜ì´ì§• -->
                <div id="announcementPagination" class="pagination hidden">
                    <!-- í˜ì´ì§• ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ê³µì§€ì‚¬í•­ ì„¹ì…˜ -->
            <div id="announcements-section" class="section hidden">
                <h2 class="section-title">
                    ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬
                </h2>

                <!-- ê³µì§€ì‚¬í•­ ì‘ì„± í¼ (êµì‚¬ë§Œ í‘œì‹œ) -->
                <div id="announcementForm" class="form-container">
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">âœï¸ ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</h3>

                    <form id="newAnnouncementForm" onsubmit="createAnnouncement(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementTitle">ğŸ“ ì œëª© *</label>
                                <input type="text" id="announcementTitle" required placeholder="ê³µì§€ì‚¬í•­ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                            <div class="form-group">
                                <label for="announcementUrgent">âš¡ ê¸´ê¸‰ë„</label>
                                <select id="announcementUrgent">
                                    <option value="normal">ğŸ“„ ì¼ë°˜</option>
                                    <option value="urgent">ğŸš¨ ê¸´ê¸‰</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="announcementContent">ğŸ“ ë‚´ìš© *</label>
                            <textarea id="announcementContent" required
                                placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì¤€ë¹„ë¬¼, ì¼ì •, ì£¼ì˜ì‚¬í•­ ë“±ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”."></textarea>
                        </div>

                        <!-- íŒŒì¼ ì²¨ë¶€ -->
                        <div class="form-group">
                            <label>ğŸ“ ì²¨ë¶€íŒŒì¼</label>
                            <div class="file-attachment">
                                <div class="file-upload-area"
                                    onclick="document.getElementById('announcementFiles').click()"
                                    ondrop="handleFileDrop(event, 'announcement')" ondragover="handleDragOver(event)"
                                    ondragleave="handleDragLeave(event)">
                                    <div class="file-upload-icon">ğŸ“</div>
                                    <div class="file-upload-text">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                                    <div class="file-upload-hint">ì´ë¯¸ì§€, ë¬¸ì„œ íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)</div>
                                </div>
                                <input type="file" id="announcementFiles" multiple
                                    accept="image/*,.pdf,.doc,.docx,.hwp,.txt" style="display: none;"
                                    onchange="handleFileSelect(event, 'announcement')">
                                <div id="announcementFileList" class="file-list"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="announcementDate">ğŸ“… ê´€ë ¨ ë‚ ì§œ</label>
                                <input type="date" id="announcementDate">
                            </div>
                            <div class="form-group">
                                <label for="announcementCategory">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬</label>
                                <select id="announcementCategory">
                                    <option value="general">ğŸ“ ì¼ë°˜</option>
                                    <option value="academic">ğŸ“š í•™ìŠµ</option>
                                    <option value="event">ğŸ‰ í–‰ì‚¬</option>
                                    <option value="safety">âš ï¸ ì•ˆì „</option>
                                    <option value="notice">ğŸ“¢ ì•Œë¦¼</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-full">
                            ğŸ“¤ ê³µì§€ì‚¬í•­ ë“±ë¡
                        </button>
                    </form>

                    <div id="announcementStatus" class="status-message hidden"></div>
                </div>

                <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ -->
                <div style="margin-top: 40px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">ğŸ“‹ ì „ì²´ ê³µì§€ì‚¬í•­</h3>
                    <div id="announcementsList">
                        <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>

                    <!-- ê³µì§€ì‚¬í•­ ê´€ë¦¬ í˜ì´ì§• -->
                    <div id="announcementManagementPagination" class="pagination hidden">
                        <!-- í˜ì´ì§• ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <!-- ë‹¬ë ¥ ì„¹ì…˜ -->
            <div id="calendar-section" class="section hidden">
                <h2 class="section-title">
                    ğŸ“… í•™êµ ë‹¬ë ¥
                </h2>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button onclick="previousMonth()">
                                â¬…ï¸
                            </button>
                            <h3 id="currentMonth">2024ë…„ 11ì›”</h3>
                            <button onclick="nextMonth()">
                                â¡ï¸
                            </button>
                        </div>
                        <p>ğŸ“Œ ì¼ì •ì„ í´ë¦­í•˜ë©´ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    </div>

                    <div class="calendar-grid" id="calendarGrid">
                        <!-- ë‹¬ë ¥ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ì„ íƒëœ ë‚ ì§œì˜ ì¼ì • -->
                <div id="selectedDateEvents" style="margin-top: 20px;">
                    <!-- ì„ íƒëœ ë‚ ì§œì˜ ì¼ì •ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì§ˆë¬¸/ìƒë‹´ ì„¹ì…˜ -->
            <div id="questions-section" class="section hidden">
                <h2 class="section-title">
                    â“ ì§ˆë¬¸ ë° ìƒë‹´
                </h2>

                <!-- ì§ˆë¬¸ ì‘ì„± í¼ (í•™ìƒ/í•™ë¶€ëª¨ìš©) -->
                <div id="questionForm" class="form-container">
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">ğŸ’­ ì„ ìƒë‹˜ê»˜ ì§ˆë¬¸í•˜ê¸°</h3>

                    <form id="newQuestionForm" onsubmit="createQuestion(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="questionTitle">ğŸ“ ì œëª© *</label>
                                <input type="text" id="questionTitle" required placeholder="ì§ˆë¬¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                            <div class="form-group">
                                <label for="questionType">ğŸ·ï¸ ì§ˆë¬¸ ìœ í˜•</label>
                                <select id="questionType">
                                    <option value="academic">ğŸ“š í•™ìŠµê´€ë ¨</option>
                                    <option value="life">ğŸ« í•™êµìƒí™œ</option>
                                    <option value="career">ğŸ¯ ì§„ë¡œìƒë‹´</option>
                                    <option value="behavior">ğŸ‘¥ ìƒí™œì§€ë„</option>
                                    <option value="other">â“ ê¸°íƒ€</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="questionContent">ğŸ’¬ ì§ˆë¬¸ ë‚´ìš© *</label>
                            <textarea id="questionContent" required
                                placeholder="ê¶ê¸ˆí•œ ë‚´ìš©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”. êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì‹¤ìˆ˜ë¡ ë” ì •í™•í•œ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                        </div>

                        <!-- íŒŒì¼ ì²¨ë¶€ -->
                        <div class="form-group">
                            <label>ğŸ“ ì²¨ë¶€íŒŒì¼</label>
                            <div class="file-attachment">
                                <div class="file-upload-area" onclick="document.getElementById('questionFiles').click()"
                                    ondrop="handleFileDrop(event, 'question')" ondragover="handleDragOver(event)"
                                    ondragleave="handleDragLeave(event)">
                                    <div class="file-upload-icon">ğŸ“</div>
                                    <div class="file-upload-text">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                                    <div class="file-upload-hint">ì´ë¯¸ì§€, ë¬¸ì„œ íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)</div>
                                </div>
                                <input type="file" id="questionFiles" multiple
                                    accept="image/*,.pdf,.doc,.docx,.hwp,.txt" style="display: none;"
                                    onchange="handleFileSelect(event, 'question')">
                                <div id="questionFileList" class="file-list"></div>
                            </div>
                        </div>

                        <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
                                <input type="checkbox" id="questionPrivate" style="width: auto; margin: 0;">
                                ğŸ”’ ë¹„ê³µê°œ ì§ˆë¬¸ (ë‹¤ë¥¸ ì‚¬ëŒì´ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)
                            </label>
                        </div>

                        <button type="submit" class="btn btn-full">
                            ğŸ’Œ ì§ˆë¬¸ ë³´ë‚´ê¸°
                        </button>
                    </form>

                    <div id="questionStatus" class="status-message hidden"></div>
                </div>

                <!-- ì§ˆë¬¸ ëª©ë¡ -->
                <div style="margin-top: 40px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">ğŸ’¬ ë‚˜ì˜ ì§ˆë¬¸ ë° ìƒë‹´ ë‚´ì—­</h3>
                    <div id="questionsList">
                        <!-- ì§ˆë¬¸ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
            <div id="search-section" class="section hidden">
                <h2 class="section-title">
                    ğŸ” í†µí•© ê²€ìƒ‰
                </h2>

                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” ì œëª©, ë‚´ìš©, ë‚ ì§œë¡œ ê²€ìƒ‰í•˜ì„¸ìš”..."
                        onkeyup="performSearch()">
                </div>

                <!-- ê²€ìƒ‰ í•„í„° -->
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="searchType">ğŸ¯ ê²€ìƒ‰ ëŒ€ìƒ</label>
                        <select id="searchType" onchange="performSearch()">
                            <option value="all">ğŸŒ ì „ì²´</option>
                            <option value="announcements">ğŸ“¢ ê³µì§€ì‚¬í•­</option>
                            <option value="questions">â“ ì§ˆë¬¸/ìƒë‹´</option>
                            <option value="calendar">ğŸ“… ì¼ì •</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchDate">ğŸ“… ë‚ ì§œ ë²”ìœ„</label>
                        <input type="month" id="searchDate" onchange="performSearch()">
                    </div>
                </div>

                <!-- ê²€ìƒ‰ ê²°ê³¼ -->
                <div id="searchResults">
                    <div style="text-align: center; color: #9ca3af; padding: 40px;">
                        ğŸ”
                        <p>ğŸ” ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- íšŒì›ê´€ë¦¬ ì„¹ì…˜ (ê´€ë¦¬ìë§Œ) -->
            <div id="users-section" class="section hidden">
                <h2 class="section-title">
                    ğŸ‘¥ íšŒì› ê´€ë¦¬
                </h2>

                <!-- íšŒì› í†µê³„ -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">ğŸ‘¨â€ğŸ“ í•™ìƒ íšŒì›</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalParents">0</div>
                        <div class="stat-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ë¶€ëª¨ íšŒì›</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingUsers">0</div>
                        <div class="stat-label">â³ ìŠ¹ì¸ ëŒ€ê¸°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">âœ… í™œì„± íšŒì›</div>
                    </div>
                </div>

                <!-- íšŒì› ëª©ë¡ -->
                <div class="user-management-container">
                    <div class="management-header">
                        <h3 style="color: #2d3748; font-weight: 600;">ğŸ“‹ ì „ì²´ íšŒì› ëª©ë¡</h3>

                        <div class="management-filters">
                            <select id="userRoleFilter" onchange="filterUsers()">
                                <option value="all">ğŸŒ ì „ì²´</option>
                                <option value="student">ğŸ‘¨â€ğŸ“ í•™ìƒ</option>
                                <option value="parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ë¶€ëª¨</option>
                                <option value="teacher">ğŸ‘¨â€ğŸ« êµì‚¬</option>
                            </select>

                            <select id="userStatusFilter" onchange="filterUsers()">
                                <option value="all">ì „ì²´ ìƒíƒœ</option>
                                <option value="active">âœ… í™œì„±</option>
                                <option value="pending">â³ ìŠ¹ì¸ëŒ€ê¸°</option>
                                <option value="suspended">âŒ ì •ì§€</option>
                            </select>
                        </div>
                    </div>

                    <div class="user-list" id="usersList">
                        <!-- íšŒì› ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <!-- ê´€ë¦¬ì íŒ¨ë„ ì„¹ì…˜ (êµì‚¬ë§Œ) -->
            <div id="admin-section" class="section hidden">
                <h2 class="section-title">
                    âš™ï¸ ê´€ë¦¬ì íŒ¨ë„
                </h2>

                <!-- ì‹œìŠ¤í…œ ì •ë³´ -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-number" id="systemVersion">v1.0</div>
                        <div class="stat-label">ğŸ”§ ì‹œìŠ¤í…œ ë²„ì „</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="dataStatus">ë¡œì»¬</div>
                        <div class="stat-label">ğŸ’¾ ë°ì´í„° ì €ì¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastBackup">ì—†ìŒ</div>
                        <div class="stat-label">ğŸ“¦ ë§ˆì§€ë§‰ ë°±ì—…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="storageUsed">0MB</div>
                        <div class="stat-label">ğŸ’½ ì €ì¥ê³µê°„</div>
                    </div>
                </div>

                <!-- ê´€ë¦¬ì ë„êµ¬ -->
                <div class="admin-tools-container">
                    <div class="tool-section">
                        <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">ğŸ‘¨â€ğŸ« êµì‚¬ ê³„ì • ê´€ë¦¬</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTeacherName">ğŸ‘¤ êµì‚¬ ì´ë¦„</label>
                                <input type="text" id="newTeacherName" placeholder="ìƒˆ êµì‚¬ ì´ë¦„ ì…ë ¥">
                            </div>
                            <div class="form-group">
                                <label for="newTeacherId">ğŸ†” ë¡œê·¸ì¸ ì•„ì´ë””</label>
                                <input type="text" id="newTeacherId" placeholder="ë¡œê·¸ì¸ìš© ì•„ì´ë””">
                            </div>
                            <div class="form-group">
                                <label for="newTeacherPassword">ğŸ”’ ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" id="newTeacherPassword" placeholder="ë¹„ë°€ë²ˆí˜¸">
                            </div>
                            <div class="form-group">
                                <label for="newTeacherClass">ğŸ« ë‹´ì„ë°˜</label>
                                <input type="text" id="newTeacherClass" placeholder="3-1, 2-2 ë“±">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="createNewTeacher()">
                            â• ìƒˆ êµì‚¬ ê³„ì • ìƒì„±
                        </button>
                    </div>

                    <div class="tool-section">
                        <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>

                        <div class="tool-buttons">
                            <button class="btn btn-secondary" onclick="exportData()">
                                ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                            </button>
                            <button class="btn btn-secondary" onclick="importData()">
                                ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                            </button>
                            <button class="btn btn-primary" onclick="backupData()">
                                ğŸ’¾ ë°±ì—… ìƒì„±
                            </button>
                            <button class="btn btn-warning" onclick="clearUserCache()"
                                style="background: #f59e0b; color: white;">
                                ğŸ”„ ì‚¬ìš©ì ìºì‹œ ì´ˆê¸°í™”
                            </button>
                            <button class="btn btn-danger" onclick="clearAllData()">
                                ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ
                            </button>
                        </div>

                        <input type="file" id="importFile" accept=".json" style="display: none;"
                            onchange="handleImportFile(event)">
                    </div>

                    <div class="tool-section">
                        <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">ğŸ”— ì™¸ë¶€ ì—°ë™</h3>

                        <div class="form-group">
                            <label for="googleScriptUrl">ğŸ“Š Firebase í”„ë¡œì íŠ¸</label>
                            <input type="text" id="googleScriptUrl" placeholder="Firebase Project ID"
                                value="kis-communication-2026" readonly>
                        </div>

                        <div class="tool-buttons">
                            <button class="btn btn-primary" onclick="testGoogleConnection()">
                                ğŸ”„ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                            <button class="btn btn-secondary" onclick="saveSettings()">
                                ğŸ’¾ ì„¤ì • ì €ì¥
                            </button>
                        </div>
                    </div>
                </div>

                <div id="adminStatus" class="status-message hidden"></div>
            </div>
        </div>
    </div> <!-- ë©”ì¸ ì•± ë -->

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null; // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´
        let isLoggedIn = false;
        let currentSection = 'dashboard';
        let announcements = [];
        let questions = [];
        let calendar = [];
        let users = []; // ë“±ë¡ëœ ì‚¬ìš©ì ëª©ë¡
        let currentDate = new Date();
        // Google Apps Script URL (Firebase ì „í™˜ ì´í›„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        const GOOGLE_SCRIPT_URL = '';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCByhTOwME2JqV24JaaQqaM0_RL2uB5geU",
            authDomain: "kis-communication-2026.firebaseapp.com",
            projectId: "kis-communication-2026",
            storageBucket: "kis-communication-2026.firebasestorage.app",
            messagingSenderId: "566029547208",
            appId: "1:566029547208:web:dfc2e491c460bec33b57fd"
        };

        let firebaseApp = null;
        let firestore = null;
        let firebaseEnabled = false;

        if (window.firebase && firebaseConfig) {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firestore = firebase.firestore();

                // ì˜¤í”„ë¼ì¸ ì§€ì†ì„± í™œì„±í™”
                firestore.enablePersistence()
                    .catch((err) => {
                        if (err.code == 'failed-precondition') {
                            console.warn('âš ï¸ ì—¬ëŸ¬ íƒ­ì´ ì—´ë ¤ìˆì–´ ì˜¤í”„ë¼ì¸ ì§€ì†ì„±ì„ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        } else if (err.code == 'unimplemented') {
                            console.warn('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ì˜¤í”„ë¼ì¸ ì§€ì†ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        }
                    });
                firebaseEnabled = true;
                console.log('âœ… Firebase ì—°ê²° ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        } else {
            console.warn('âš ï¸ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // í˜ì´ì§• ê´€ë ¨ ë³€ìˆ˜
        let currentPage = 1;
        let itemsPerPage = 5;
        let totalPages = 1;

        // ê³µì§€ì‚¬í•­ ê´€ë¦¬ í˜ì´ì§• ë³€ìˆ˜
        let currentManagementPage = 1;
        let managementItemsPerPage = 5;
        let managementTotalPages = 1;

        // íŒŒì¼ ì²¨ë¶€ ê´€ë ¨ ë³€ìˆ˜
        let announcementFiles = [];
        let questionFiles = [];

        // ì•Œë¦¼ ê´€ë ¨ ë³€ìˆ˜
        let unreadCount = 0;
        let holidays = [
            '2024-11-28', // ì¶”ìˆ˜ê°ì‚¬ì ˆ (ì˜ˆì‹œ)
            '2024-12-25', // í¬ë¦¬ìŠ¤ë§ˆìŠ¤
            '2025-01-01', // ì‹ ì •
            '2025-02-10', // ì„¤ë‚  ì—°íœ´
            '2025-02-11', // ì„¤ë‚ 
            '2025-02-12', // ì„¤ë‚  ì—°íœ´
            '2025-03-01', // ì‚¼ì¼ì ˆ
            '2025-05-05', // ì–´ë¦°ì´ë‚ 
            '2025-06-06', // í˜„ì¶©ì¼
            '2025-08-15', // ê´‘ë³µì ˆ
            '2025-10-03', // ê°œì²œì ˆ
            '2025-10-09', // í•œê¸€ë‚ 
        ];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            // PWA ì„¤ì¹˜ ìƒíƒœ í™•ì¸ ë° ì •ë¦¬
            checkPWAInstallationStatus();

            // Firebase ì´ˆê¸°í™” ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦° í›„ ì¸ì¦ ì´ˆê¸°í™”
            const waitForFirebase = () => {
                // Firebaseê°€ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆê±°ë‚˜, firebaseReady ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼
                if (window.firebaseEnabled && window.firestore) {
                    console.log('âœ… Firebase ì¤€ë¹„ ì™„ë£Œ - ì¸ì¦ ì´ˆê¸°í™” ì‹œì‘');
                    initializeAuth();
                } else {
                    // Firebase ì¤€ë¹„ ëŒ€ê¸° (ìµœëŒ€ 3ì´ˆ)
                    let attempts = 0;
                    const maxAttempts = 30;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (window.firebaseEnabled && window.firestore) {
                            clearInterval(checkInterval);
                            console.log('âœ… Firebase ì¤€ë¹„ ì™„ë£Œ - ì¸ì¦ ì´ˆê¸°í™” ì‹œì‘');
                            initializeAuth();
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            console.warn('âš ï¸ Firebase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ - ë¡œì»¬ ëª¨ë“œë¡œ ì‹œì‘');
                            initializeAuth();
                        }
                    }, 100);

                    // firebaseReady ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¹ ë¥¸ ì´ˆê¸°í™” ëŒ€ë¹„)
                    window.addEventListener('firebaseReady', () => {
                        clearInterval(checkInterval);
                        console.log('âœ… Firebase ì¤€ë¹„ ì™„ë£Œ (ì´ë²¤íŠ¸) - ì¸ì¦ ì´ˆê¸°í™” ì‹œì‘');
                        initializeAuth();
                    }, { once: true });
                }
            };

            waitForFirebase();
        });

        // PWA ì„¤ì¹˜ ìƒíƒœ í™•ì¸ ë° ì •ë¦¬
        function checkPWAInstallationStatus() {
            // standalone ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì´ë©´ ì¦‰ì‹œ ì„¤ì¹˜ ê¸°ë¡ ì €ì¥
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                localStorage.setItem('pwa_installed', 'true');
            }

            if (isPWAInstalled()) {
                console.log('âœ… PWAê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                // ì„¤ì¹˜ ë²„íŠ¼ì´ ìˆë‹¤ë©´ ì œê±°
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.remove();
                }
                // deferredPrompt ì´ˆê¸°í™”
                deferredPrompt = null;
            } else {
                console.log('ğŸ“± PWA ì„¤ì¹˜ ê°€ëŠ¥ ìƒíƒœì…ë‹ˆë‹¤.');
            }
        }

        // ì¸ì¦ ì´ˆê¸°í™”
        async function initializeAuth() {
            // ê¸°ë³¸ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
            loadSampleUsers();
            ensureDefaultTeacherAccount();

            // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
            loadStoredData();
            ensureDefaultTeacherAccount();

            // Firebase ì‚¬ìš©ì ë°ì´í„° ë¨¼ì € ë™ê¸°í™” (ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì „ì—)
            if (firebaseEnabled && firestore) {
                try {
                    const sheetsUsers = await loadFromGoogleSheets('getUsers');
                    if (sheetsUsers !== null && sheetsUsers.length > 0) {
                        // êµì‚¬ ê³„ì • ë³´ì¡´
                        const teacherAccounts = users.filter(u => u.role === 'teacher');
                        const sheetsUserIds = new Set(sheetsUsers.map(u => u.id));

                        // Firebase ì‚¬ìš©ì ë°ì´í„°ì™€ êµì‚¬ ê³„ì • ë³‘í•©
                        users = [...sheetsUsers];

                        // êµì‚¬ ê³„ì • ë³´ì¡´
                        teacherAccounts.forEach(teacher => {
                            if (!sheetsUserIds.has(teacher.id)) {
                                users.push(teacher);
                            } else {
                                const firebaseTeacherIndex = users.findIndex(u => u.id === teacher.id);
                                if (firebaseTeacherIndex >= 0) {
                                    users[firebaseTeacherIndex].password = teacher.password;
                                }
                            }
                        });

                        localStorage.setItem('users', JSON.stringify(users));
                        console.log('âœ… ì´ˆê¸°í™”: Firebase ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
                        ensureDefaultTeacherAccount();
                    }
                } catch (error) {
                    console.warn('âš ï¸ ì´ˆê¸°í™”: ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©:', error);
                }
            }

            // ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” í›„ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ìœ íš¨ì„± ê²€ì¦ í¬í•¨)
            await checkLoginStatus();

            // í˜ì´ì§€ í‘œì‹œ
            if (isLoggedIn && currentUser) {
                // ì¶”ê°€ ë°ì´í„° ë™ê¸°í™”
                await syncWithGoogleSheets();
                // Firebase ë™ê¸°í™” í›„ì—ë„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œì»¬ ë°ì´í„° ë¡œë“œ
                if (announcements.length === 0 && questions.length === 0) {
                    loadStoredData();
                }
                showMainApp();
                // ìë™ ë™ê¸°í™” ì‹œì‘
                startAutoSync();
            } else {
                // ë¡œê·¸ì¸ ì „ì—ëŠ” ë¡œì»¬ ë°ì´í„°ë§Œ ë¡œë“œ
                loadStoredData();
                showLogin();
                // ìë™ ë™ê¸°í™” ì¤‘ì§€
                stopAutoSync();
            }
        }

        // ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
        function loadStoredData() {
            try {
                // ê³µì§€ì‚¬í•­ ë¡œë“œ
                const savedAnnouncements = localStorage.getItem('announcements');
                if (savedAnnouncements) {
                    announcements = JSON.parse(savedAnnouncements);
                }

                // ì§ˆë¬¸ ë¡œë“œ
                const savedQuestions = localStorage.getItem('questions');
                if (savedQuestions) {
                    questions = JSON.parse(savedQuestions);
                }

                // ì‚¬ìš©ì ë¡œë“œ
                const savedUsers = localStorage.getItem('users');
                if (savedUsers) {
                    const loadedUsers = JSON.parse(savedUsers);

                    // êµì‚¬ ê³„ì • ë¨¼ì € í™•ì¸ ë° ë³´ì¡´
                    const localTeacherAccounts = users.filter(u => u.role === 'teacher');
                    const loadedUserIds = new Set(loadedUsers.map(u => u.id));

                    // ë¡œì»¬ êµì‚¬ ê³„ì •ì´ ì €ì¥ëœ ë°ì´í„°ì— ì—†ìœ¼ë©´ ì¶”ê°€ (êµì‚¬ ê³„ì • ë³´ì¡´)
                    localTeacherAccounts.forEach(teacher => {
                        if (!loadedUserIds.has(teacher.id)) {
                            loadedUsers.push(teacher);
                        } else {
                            // ì €ì¥ëœ êµì‚¬ ê³„ì •ì´ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ëŠ” ë¡œì»¬ ê²ƒì„ ìœ ì§€
                            const savedTeacherIndex = loadedUsers.findIndex(u => u.id === teacher.id);
                            if (savedTeacherIndex >= 0) {
                                loadedUsers[savedTeacherIndex].password = teacher.password;
                            }
                        }
                    });

                    // ì €ì¥ëœ ì‚¬ìš©ì ë°ì´í„° ì‚¬ìš© (êµì‚¬ ê³„ì • ë³´ì¡´ë¨)
                    users = loadedUsers;
                }

                // ìº˜ë¦°ë” ë¡œë“œ
                const savedCalendar = localStorage.getItem('calendar');
                if (savedCalendar) {
                    calendar = JSON.parse(savedCalendar);
                }
            } catch (error) {
                console.error('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }

            ensureDefaultTeacherAccount();
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ì‚¬ìš©ì ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ í¬í•¨)
        async function checkLoginStatus() {
            currentUser = null;
            isLoggedIn = false;

            // sessionStorageë¥¼ ìš°ì„  í™•ì¸ (í˜„ì¬ ì„¸ì…˜ì—ì„œë§Œ ìœ ì§€)
            const sessionUser = sessionStorage.getItem('currentUser');
            let savedUserData = null;

            if (sessionUser) {
                try {
                    savedUserData = JSON.parse(sessionUser);
                } catch (e) {
                    console.error('sessionStorage ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
                    sessionStorage.removeItem('currentUser');
                }
            }

            // ì €ì¥ëœ ì‚¬ìš©ì ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ íš¨ì„± ê²€ì¦
            if (savedUserData) {
                // users ë°°ì—´ì—ì„œ ì‹¤ì œ ì‚¬ìš©ì ì°¾ê¸° (ID, userId, ìƒíƒœ ëª¨ë‘ í™•ì¸)
                const actualUser = users.find(u =>
                    u.id === savedUserData.id &&
                    u.userId === savedUserData.userId &&
                    u.role === savedUserData.role
                );

                if (actualUser && actualUser.status === 'active') {
                    // ìœ íš¨í•œ ì‚¬ìš©ì - ë¡œê·¸ì¸ ìœ ì§€
                    currentUser = {
                        ...actualUser,
                        lastLogin: savedUserData.lastLogin || new Date().toISOString()
                    };
                    isLoggedIn = true;
                    console.log('âœ… ìœ íš¨í•œ ë¡œê·¸ì¸ ì„¸ì…˜ ë³µì›:', currentUser.name);
                } else {
                    // ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ìš©ì - ìë™ ë¡œê·¸ì•„ì›ƒ
                    console.warn('âš ï¸ ì €ì¥ëœ ì‚¬ìš©ìê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬:', savedUserData.userId);
                    sessionStorage.removeItem('currentUser');
                    localStorage.removeItem('currentUser');
                    currentUser = null;
                    isLoggedIn = false;
                }
            } else {
                // sessionStorageì— ë°ì´í„° ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”
                currentUser = null;
                isLoggedIn = false;
                // localStorageì˜ currentUserë„ ì œê±° (ì¼ê´€ì„± ìœ ì§€)
                localStorage.removeItem('currentUser');
            }
        }

        // ë©”ì¸ ì•± í‘œì‹œ
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('signupPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            if (currentUser) {
                updateUserInterface();
                initializeApp();
                loadSampleData();
            }
        }

        // ë¡œê·¸ì¸ í˜ì´ì§€ í‘œì‹œ
        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('signupPage').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');

            // ë¡œê·¸ì¸ í¼ ì™„ì „ ì´ˆê¸°í™”
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.reset();
            }

            // ê°œë³„ í•„ë“œ ëª…ì‹œì  ì´ˆê¸°í™” (ë¸Œë¼ìš°ì € ìë™ì™„ì„± ë°©ì§€)
            const loginRole = document.getElementById('loginRole');
            const loginId = document.getElementById('loginId');
            const loginPassword = document.getElementById('loginPassword');

            if (loginRole) {
                loginRole.value = '';
                loginRole.selectedIndex = 0;
            }
            if (loginId) {
                loginId.value = '';
            }
            if (loginPassword) {
                loginPassword.value = '';
            }

            // ë¡œê·¸ì¸ ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
            const loginStatus = document.getElementById('loginStatus');
            if (loginStatus) {
                loginStatus.classList.add('hidden');
                loginStatus.textContent = '';
            }
        }

        // íšŒì›ê°€ì… í˜ì´ì§€ í‘œì‹œ
        function showSignup() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('signupPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // íšŒì›ê°€ì… í¼ ì—…ë°ì´íŠ¸
        function updateSignupForm() {
            const role = document.getElementById('signupRole').value;

            // ëª¨ë“  ì—­í• ë³„ í•„ë“œ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.role-fields').forEach(field => {
                field.classList.add('hidden');
            });

            // ì„ íƒëœ ì—­í• ì— ë”°ë¼ í•„ë“œ í‘œì‹œ
            if (role) {
                document.getElementById(role + 'Fields').classList.remove('hidden');
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin(event) {
            event.preventDefault();

            const role = document.getElementById('loginRole').value;
            const loginId = document.getElementById('loginId').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!role || !loginId || !password) {
                showAuthStatus('loginStatus', 'âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë¨¼ì € ê¸°ë³¸ êµì‚¬ ê³„ì •ì´ ì¡´ì¬í•˜ë„ë¡ ë³´ì¥
            ensureDefaultTeacherAccount();

            // ë¡œê·¸ì¸ ì‹œ Firebaseì—ì„œ ìµœì‹  ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™”
            if (firebaseEnabled && firestore) {
                showAuthStatus('loginStatus', 'ğŸ”„ ìµœì‹  ì •ë³´ í™•ì¸ ì¤‘...', 'info');

                try {
                    const sheetsUsers = await loadFromGoogleSheets('getUsers');
                    if (sheetsUsers !== null && sheetsUsers.length > 0) {
                        // êµì‚¬ ê³„ì •ì„ ë¨¼ì € ë³´ì¡´ (ë¡œì»¬ì— ìˆëŠ” êµì‚¬ ê³„ì •)
                        const teacherAccounts = users.filter(u => u.role === 'teacher');
                        const sheetsUserIds = new Set(sheetsUsers.map(u => u.id));

                        // Firebase ì‚¬ìš©ì ë°ì´í„°ì™€ êµì‚¬ ê³„ì • ë³‘í•©
                        users = [...sheetsUsers];

                        // êµì‚¬ ê³„ì •ì´ Firebaseì— ì—†ë‹¤ë©´ ì¶”ê°€ (ë¡œì»¬ êµì‚¬ ê³„ì • ë³´ì¡´)
                        teacherAccounts.forEach(teacher => {
                            if (!sheetsUserIds.has(teacher.id)) {
                                users.push(teacher);
                                console.log('âœ… êµì‚¬ ê³„ì • ë³´ì¡´:', teacher.userId);
                            } else {
                                // Firebaseì— ìˆëŠ” êµì‚¬ ê³„ì • ë°ì´í„°ë„ ì—…ë°ì´íŠ¸í•˜ë˜, ë¹„ë°€ë²ˆí˜¸ëŠ” ìœ ì§€
                                const firebaseTeacherIndex = users.findIndex(u => u.id === teacher.id);
                                if (firebaseTeacherIndex >= 0) {
                                    users[firebaseTeacherIndex].password = teacher.password; // ë¹„ë°€ë²ˆí˜¸ ë³´ì¡´
                                }
                            }
                        });

                        localStorage.setItem('users', JSON.stringify(users));
                        console.log('âœ… ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ (êµì‚¬ ê³„ì • ë³´ì¡´ë¨)');
                    } else {
                        // Firebaseì— ì‚¬ìš©ìê°€ ì—†ì–´ë„ ê¸°ë³¸ êµì‚¬ ê³„ì •ì€ ë³´ì¡´
                        console.log('âš ï¸ Firebaseì— ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                    }
                } catch (error) {
                    console.warn('âš ï¸ ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©:', error);
                }
            }

            // Firebase ë™ê¸°í™” í›„ì—ë„ ê¸°ë³¸ êµì‚¬ ê³„ì • ë³´ì¥
            ensureDefaultTeacherAccount();

            // ë””ë²„ê¹…: í˜„ì¬ users ë°°ì—´ ìƒíƒœ í™•ì¸
            console.log('ğŸ” ë¡œê·¸ì¸ ì‹œë„ - í˜„ì¬ users ë°°ì—´:', users.length + 'ëª…');
            const teacherCheck = users.find(u => u.role === 'teacher' && u.userId === 'cts1000');
            if (teacherCheck) {
                console.log('âœ… êµì‚¬ ê³„ì • í™•ì¸ë¨:', teacherCheck.userId, 'status:', teacherCheck.status, 'password:', teacherCheck.password ? 'ìˆìŒ' : 'ì—†ìŒ');
            } else {
                console.error('âŒ êµì‚¬ ê³„ì •ì´ users ë°°ì—´ì— ì—†ìŠµë‹ˆë‹¤!');
                // ê°•ì œë¡œ ì¶”ê°€
                ensureDefaultTeacherAccount();
            }

            // ì‚¬ìš©ì ì°¾ê¸°
            let user = null;

            // ëª¨ë“  ì‚¬ìš©ìëŠ” ì•„ì´ë””ë¡œ ë¡œê·¸ì¸
            user = users.find(u => u.role === role && u.userId === loginId && u.password === password);

            // ë””ë²„ê¹…: ì‚¬ìš©ì ê²€ìƒ‰ ê²°ê³¼
            if (!user) {
                console.error('âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ê²€ìƒ‰ ì¡°ê±´:', { role, loginId, password: password ? 'ì…ë ¥ë¨' : 'ì—†ìŒ' });
                console.log('í˜„ì¬ users ë°°ì—´:', users.map(u => ({ role: u.role, userId: u.userId, status: u.status })));

                // êµì‚¬ ê³„ì •ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                if (role === 'teacher' && loginId === 'cts1000') {
                    console.log('ğŸ”§ êµì‚¬ ê³„ì • ë¡œê·¸ì¸ ì‹œë„ ê°ì§€ - ê°•ì œ ë³µêµ¬ ì‹œë„');
                    ensureDefaultTeacherAccount();
                    user = users.find(u => u.role === 'teacher' && u.userId === 'cts1000' && u.password === '3535');
                    if (user) {
                        console.log('âœ… êµì‚¬ ê³„ì • ë³µêµ¬ ì„±ê³µ');
                    }
                }
            } else {
                console.log('âœ… ì‚¬ìš©ì ì°¾ìŒ:', user.name, 'status:', user.status);
            }

            if (user && user.status === 'active') {
                // ë¡œê·¸ì¸ ì„±ê³µ
                currentUser = {
                    ...user,
                    lastLogin: new Date().toISOString()
                };

                // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex].lastLogin = currentUser.lastLogin;
                    // localStorage ì—…ë°ì´íŠ¸
                    localStorage.setItem('users', JSON.stringify(users));
                }

                isLoggedIn = true;
                // sessionStorageì— ì €ì¥ (í˜„ì¬ ì„¸ì…˜ì—ì„œë§Œ ìœ ì§€)
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                // localStorageì—ë„ ë°±ì—… ì €ì¥ (ì„ íƒì‚¬í•­)
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // ë¡œê·¸ì¸ í¼ ì´ˆê¸°í™”
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.reset();
                }

                showAuthStatus('loginStatus', 'ğŸ‰ ë¡œê·¸ì¸ ì„±ê³µ!', 'success');

                setTimeout(() => {
                    showMainApp();
                }, 1000);

            } else if (user && user.status === 'pending') {
                showAuthStatus('loginStatus', 'â³ ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤.', 'info');
                // ë¡œê·¸ì¸ í¼ì€ ìœ ì§€ (ì¬ì‹œë„ ê°€ëŠ¥í•˜ë„ë¡)
            } else {
                // ë¡œê·¸ì¸ ì‹¤íŒ¨ - ìì„¸í•œ ë””ë²„ê¹… ì •ë³´
                let errorMessage = 'âŒ ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';

                if (role === 'teacher' && loginId === 'cts1000') {
                    // êµì‚¬ ê³„ì • ë¡œê·¸ì¸ ì‹¤íŒ¨ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                    const teacherUser = users.find(u => u.role === 'teacher' && u.userId === 'cts1000');
                    if (!teacherUser) {
                        errorMessage += '\n\nâš ï¸ êµì‚¬ ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
                        console.error('âŒ êµì‚¬ ê³„ì •ì´ users ë°°ì—´ì— ì—†ìŠµë‹ˆë‹¤! ê°•ì œ ë³µêµ¬ ì‹œë„...');
                        ensureDefaultTeacherAccount();
                        // ì¦‰ì‹œ ì¬ì‹œë„
                        const retryUser = users.find(u => u.role === 'teacher' && u.userId === 'cts1000' && u.password === '3535');
                        if (retryUser && retryUser.status === 'active') {
                            errorMessage = 'ğŸ”„ ê³„ì •ì„ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                            showAuthStatus('loginStatus', errorMessage, 'info');
                            return;
                        }
                    } else if (teacherUser.password !== password) {
                        errorMessage += '\n\nâš ï¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        console.error('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜:', { ì…ë ¥: password, ì €ì¥: teacherUser.password ? 'ìˆìŒ' : 'ì—†ìŒ' });
                    } else if (teacherUser.status !== 'active') {
                        errorMessage += '\n\nâš ï¸ ê³„ì • ìƒíƒœ: ' + (teacherUser.status || 'ì•Œ ìˆ˜ ì—†ìŒ');
                    }
                }

                showAuthStatus('loginStatus', errorMessage + '\n\nğŸ’¡ íšŒì›ê°€ì…ì´ í•„ìš”í•˜ì‹ ê°€ìš”?', 'error');
                // ë¹„ë°€ë²ˆí˜¸ í•„ë“œë§Œ ì´ˆê¸°í™” (ì•„ì´ë””ëŠ” ìœ ì§€)
                const passwordField = document.getElementById('loginPassword');
                if (passwordField) {
                    passwordField.value = '';
                }
            }
        }

        // íšŒì›ê°€ì… ì²˜ë¦¬
        function handleSignup(event) {
            event.preventDefault();

            const role = document.getElementById('signupRole').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!role) {
                showAuthStatus('signupStatus', 'âš ï¸ ì‚¬ìš©ì êµ¬ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showAuthStatus('signupStatus', 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            let userData = {
                id: 'user_' + Date.now(),
                role: role,
                password: password,
                status: 'pending', // ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœ
                joinDate: new Date().toISOString().split('T')[0],
                lastLogin: null
            };

            if (role === 'student') {
                const userId = document.getElementById('studentUserId').value.trim();
                const name = document.getElementById('studentName').value.trim();

                if (!userId || !name) {
                    showAuthStatus('signupStatus', 'âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
                const existingUser = users.find(u => u.userId === userId);
                if (existingUser) {
                    showAuthStatus('signupStatus', 'âŒ ì´ë¯¸ ë“±ë¡ëœ ì•„ì´ë””ì…ë‹ˆë‹¤.', 'error');
                    return;
                }

                userData.name = name;
                userData.userId = userId;

            } else if (role === 'parent') {
                const userId = document.getElementById('parentUserId').value.trim();
                const name = document.getElementById('parentName').value.trim();

                if (!userId || !name) {
                    showAuthStatus('signupStatus', 'âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ì•„ì´ë”” ì¤‘ë³µ í™•ì¸
                const existingUser = users.find(u => u.userId === userId);
                if (existingUser) {
                    showAuthStatus('signupStatus', 'âŒ ì´ë¯¸ ë“±ë¡ëœ ì•„ì´ë””ì…ë‹ˆë‹¤.', 'error');
                    return;
                }

                userData.name = name;
                userData.userId = userId;
            }

            // ì‚¬ìš©ì ë“±ë¡ (statusë¥¼ ëª…ì‹œì ìœ¼ë¡œ pendingìœ¼ë¡œ ì„¤ì •)
            userData.status = 'pending';
            users.push(userData);

            // localStorageì— ìë™ ì €ì¥
            localStorage.setItem('users', JSON.stringify(users));

            // Firebaseì— ì €ì¥ (ë¹„ë™ê¸°) - status ëª…ì‹œì ìœ¼ë¡œ ë³´ì¥
            console.log('ğŸ“¤ íšŒì›ê°€ì… ë°ì´í„°:', userData);
            const userDataForFirebase = {
                ...userData,
                status: 'pending' // ëª…ì‹œì ìœ¼ë¡œ pending ìƒíƒœ ë³´ì¥
            };

            saveToGoogleSheets('saveUser', { user: userDataForFirebase }).then((result) => {
                if (result && result.success) {
                    console.log('âœ… íšŒì›ê°€ì… ì •ë³´ê°€ Firebaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (status: pending)');
                } else {
                    console.warn('âš ï¸ Firebase ì €ì¥ ì‘ë‹µ:', result);
                }
            }).catch(err => {
                console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', err);
                // ì €ì¥ ì‹¤íŒ¨í•´ë„ íšŒì›ê°€ì…ì€ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ë¡œì»¬ì—ëŠ” ì €ì¥ë¨)
            });

            // ìŠ¹ì¸ í•„ìš” ë©”ì‹œì§€ í‘œì‹œ
            showAuthStatus('signupStatus', 'ğŸ‰ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâ³ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nğŸ’¡ ìŠ¹ì¸ ì™„ë£Œë˜ë©´ ë¡œê·¸ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');

            // í¼ ì´ˆê¸°í™”
            document.getElementById('signupForm').reset();
            updateSignupForm();

            // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í›„ í™”ë©´ ì „í™˜ (3ì´ˆ í›„)
            setTimeout(() => {
                // ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                const statusElement = document.getElementById('signupStatus');
                if (statusElement) {
                    statusElement.classList.add('hidden');
                }
                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                showLogin();
                // ë¡œê·¸ì¸ í˜ì´ì§€ì— ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                showAuthStatus('loginStatus', 'âœ… íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nâ³ ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'info');
            }, 3000);
        }

        // ì•± ì´ˆê¸°í™”
        function initializeApp() {
            updateUserProfile();
            showSection('dashboard');
            generateCalendar();
            updateDashboard();

            // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (í•™ìƒ/í•™ë¶€ëª¨ë§Œ)
            if (currentUser && currentUser.role !== 'teacher') {
                requestNotificationPermission();
            }
        }

        // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(function (permission) {
                    if (permission === 'granted') {
                        console.log('âœ… ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }
        }

        // ìƒ˜í”Œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
        function loadSampleUsers() {
            users = [
                getDefaultTeacherAccountTemplate()
                // ìƒ˜í”Œ í•™ìƒ ë° í•™ë¶€ëª¨ ê³„ì •ì€ ì‚­ì œë¨
            ];
        }

        function getDefaultTeacherAccountTemplate() {
            return {
                id: 'teacher001',
                role: 'teacher',
                name: 'ë¹¨ê°„ì•„ë¹ ',
                userId: 'cts1000',
                password: '3535',
                email: 'cts100000@gmail.com',
                class: '10-2',
                status: 'active',
                joinDate: '2025-11-18',
                lastLogin: null
            };
        }

        function ensureDefaultTeacherAccount() {
            if (!Array.isArray(users)) {
                users = [];
            }

            const defaultTeacher = getDefaultTeacherAccountTemplate();
            const existingIndex = users.findIndex(u => u.id === defaultTeacher.id || u.userId === defaultTeacher.userId);
            let teacherRecord = null;
            let didUpdate = false;

            if (existingIndex === -1) {
                teacherRecord = { ...defaultTeacher };
                users.push(teacherRecord);
                didUpdate = true;
            } else {
                const existing = users[existingIndex];
                teacherRecord = {
                    ...existing,
                    ...defaultTeacher,
                    lastLogin: existing.lastLogin || defaultTeacher.lastLogin
                };

                // í•µì‹¬ í•„ë“œ ê°•ì œ ìœ ì§€
                teacherRecord.role = 'teacher';
                teacherRecord.status = 'active';
                teacherRecord.userId = defaultTeacher.userId;
                teacherRecord.password = defaultTeacher.password;
                teacherRecord.name = defaultTeacher.name;
                teacherRecord.email = existing.email || defaultTeacher.email;
                teacherRecord.class = existing.class || defaultTeacher.class;

                const fieldsToCompare = ['role', 'status', 'userId', 'password', 'name', 'email', 'class'];
                didUpdate = fieldsToCompare.some(field => existing[field] !== teacherRecord[field]);

                if (didUpdate) {
                    users[existingIndex] = teacherRecord;
                } else {
                    teacherRecord = users[existingIndex];
                }
            }

            if (didUpdate) {
                try {
                    localStorage.setItem('users', JSON.stringify(users));
                    console.log('âœ… ê¸°ë³¸ êµì‚¬ ê³„ì •ì„ ë³´ì¡´í–ˆìŠµë‹ˆë‹¤.');
                } catch (storageError) {
                    console.warn('âš ï¸ ê¸°ë³¸ êµì‚¬ ê³„ì •ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', storageError);
                }
            }

            if (teacherRecord && firebaseEnabled && firestore) {
                firestore.collection('users').doc(defaultTeacher.id)
                    .set({
                        ...teacherRecord,
                        status: 'active',
                        role: 'teacher',
                        userId: defaultTeacher.userId,
                        password: defaultTeacher.password
                    }, { merge: true })
                    .then(() => {
                        if (didUpdate) {
                            console.log('âœ… Firebaseì— ê¸°ë³¸ êµì‚¬ ê³„ì •ì„ ë™ê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
                        }
                    })
                    .catch(err => console.warn('âš ï¸ Firebase ê¸°ë³¸ êµì‚¬ ê³„ì • ë™ê¸°í™” ì‹¤íŒ¨:', err));
            }

            return teacherRecord;
        }

        // ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸
        function updateUserInterface() {
            if (!currentUser) return;

            // ì‚¬ìš©ìë³„ ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€
            if (currentUser.role === 'teacher') {
                document.body.classList.add('teacher-visible');
                document.body.classList.remove('student-visible', 'parent-visible');
            } else if (currentUser.role === 'student') {
                document.body.classList.add('student-visible');
                document.body.classList.remove('teacher-visible', 'parent-visible');
            } else if (currentUser.role === 'parent') {
                document.body.classList.add('parent-visible');
                document.body.classList.remove('teacher-visible', 'student-visible');
            }

            // êµì‚¬ê°€ ì•„ë‹Œ ê²½ìš° ê³µì§€ì‚¬í•­ ì‘ì„± í¼ ìˆ¨ê¹€
            const announcementForm = document.getElementById('announcementForm');
            if (announcementForm) {
                if (currentUser.role === 'teacher') {
                    announcementForm.style.display = 'block';
                } else {
                    announcementForm.style.display = 'none';
                }
            }

            // ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸
            updateNotificationBadge();
        }

        // ì‚¬ìš©ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸
        function updateUserProfile() {
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleText(currentUser.role) +
                (currentUser.class ? ` (${currentUser.class}ë°˜ ë‹´ì„)` : '');

            // ì—­í• ë³„ ì´ëª¨ì§€ ì•„ë°”íƒ€
            const roleEmojis = {
                'teacher': 'ğŸ‘¨â€ğŸ«',
                'student': 'ğŸ‘¨â€ğŸ“',
                'parent': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'
            };
            document.getElementById('userAvatar').textContent = roleEmojis[currentUser.role] || 'ğŸ‘¤';
        }

        // ì—­í•  í…ìŠ¤íŠ¸ ë³€í™˜
        function getRoleText(role) {
            const roleMap = {
                'teacher': 'êµì‚¬',
                'student': 'í•™ìƒ',
                'parent': 'í•™ë¶€ëª¨'
            };
            return roleMap[role] || role;
        }

        // ì¸ì¦ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showAuthStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.classList.remove('hidden');

            setTimeout(() => {
                element.classList.add('hidden');
            }, 4000);
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ìë™ ë™ê¸°í™” ì¤‘ì§€ (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë„ í•¨ê»˜ í•´ì œë¨)
                stopAutoSync();

                // Firebase ë¦¬ìŠ¤ë„ˆ í•´ì œ
                if (typeof unsubscribeFirebaseListeners === 'function') {
                    unsubscribeFirebaseListeners();
                }

                currentUser = null;
                isLoggedIn = false;
                // sessionStorageì™€ localStorage ëª¨ë‘ ì‚­ì œ
                sessionStorage.removeItem('currentUser');
                localStorage.removeItem('currentUser');

                // ë°ì´í„° ì´ˆê¸°í™”
                announcements = [];
                questions = [];
                calendar = [];

                // ë¡œê·¸ì¸ í¼ ì™„ì „ ì´ˆê¸°í™” (ê°œë³„ í•„ë“œë„ ëª…ì‹œì ìœ¼ë¡œ ì´ˆê¸°í™”)
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.reset();
                }

                // ê°œë³„ í•„ë“œ ëª…ì‹œì  ì´ˆê¸°í™” (ë¸Œë¼ìš°ì € ìë™ì™„ì„± ë°©ì§€)
                const loginRole = document.getElementById('loginRole');
                const loginId = document.getElementById('loginId');
                const loginPassword = document.getElementById('loginPassword');

                if (loginRole) {
                    loginRole.value = '';
                    loginRole.selectedIndex = 0;
                }
                if (loginId) {
                    loginId.value = '';
                }
                if (loginPassword) {
                    loginPassword.value = '';
                }

                // ë¡œê·¸ì¸ ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
                const loginStatus = document.getElementById('loginStatus');
                if (loginStatus) {
                    loginStatus.classList.add('hidden');
                    loginStatus.textContent = '';
                }

                // íšŒì›ê°€ì… ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
                const signupStatus = document.getElementById('signupStatus');
                if (signupStatus) {
                    signupStatus.classList.add('hidden');
                    signupStatus.textContent = '';
                }

                showLogin();
                console.log('ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ - ë¡œê·¸ì¸ í¼ ì™„ì „ ì´ˆê¸°í™”ë¨');
            }
        }

        // ì„¹ì…˜ í‘œì‹œ (ìˆ˜ì •ë¨ - users ì„¹ì…˜ ì¶”ê°€)
        function showSection(sectionName, element = null) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            // ì„ íƒëœ íƒ­ í™œì„±í™” - elementê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì°¾ê¸°
            const activeTab = element || document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            currentSection = sectionName;

            // ì„¹ì…˜ë³„ ì´ˆê¸°í™”
            switch (sectionName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'announcements':
                    loadAnnouncements();
                    break;
                case 'calendar':
                    generateCalendar();
                    break;
                case 'questions':
                    loadQuestions();
                    break;
                case 'users':
                    if (currentUser && currentUser.role === 'teacher') {
                        loadUserManagement();
                    }
                    break;
                case 'admin':
                    if (currentUser && currentUser.role === 'teacher') {
                        loadAdminPanel();
                    }
                    break;
                case 'search':
                    // ê²€ìƒ‰ ì„¹ì…˜ì€ ë³„ë„ ì´ˆê¸°í™” ë¶ˆí•„ìš”
                    break;
            }
        }

        // íšŒì› ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ
        async function loadUserManagement() {
            // íšŒì› ê´€ë¦¬ í™”ë©´ì„ ì—´ ë•Œë§ˆë‹¤ ìµœì‹  ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™”
            if (firebaseEnabled && firestore) {
                console.log('ğŸ”„ íšŒì› ê´€ë¦¬: ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” ì¤‘...');
                const sheetsUsers = await loadFromGoogleSheets('getUsers');
                if (sheetsUsers !== null) {
                    // ì‚­ì œëœ íšŒì› ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const deletedUserIds = new Set(JSON.parse(localStorage.getItem('deletedUserIds') || '[]'));

                    // ì‚­ì œëœ íšŒì›ì€ ì œì™¸í•˜ê³  í•„í„°ë§
                    const validUsers = sheetsUsers.filter(u => !deletedUserIds.has(u.id));

                    // êµì‚¬ ê³„ì • ë³´ì¡´
                    const teacherAccounts = users.filter(u => u.role === 'teacher');
                    const validUserIds = new Set(validUsers.map(u => u.id));

                    // ê¸°ì¡´ users ë°°ì—´ê³¼ ë³‘í•© (ì‚­ì œëœ íšŒì›ì€ ì œì™¸)
                    const mergedUsers = [];

                    // Firebaseì—ì„œ ê°€ì ¸ì˜¨ ìœ íš¨í•œ ì‚¬ìš©ì ì¶”ê°€ (êµì‚¬ ì œì™¸)
                    validUsers.forEach(user => {
                        if (user.role !== 'teacher') {
                            mergedUsers.push(user);
                        }
                    });

                    // êµì‚¬ ê³„ì • ì¶”ê°€ (ë¡œì»¬ êµì‚¬ ê³„ì • ìš°ì„ )
                    teacherAccounts.forEach(teacher => {
                        const firebaseTeacher = validUsers.find(u => u.id === teacher.id && u.role === 'teacher');
                        if (firebaseTeacher) {
                            // Firebaseì— êµì‚¬ ê³„ì •ì´ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ë§Œ ë¡œì»¬ ê²ƒì„ ì‚¬ìš©
                            mergedUsers.push({
                                ...firebaseTeacher,
                                password: teacher.password
                            });
                        } else {
                            // Firebaseì— êµì‚¬ ê³„ì •ì´ ì—†ìœ¼ë©´ ë¡œì»¬ êµì‚¬ ê³„ì • ì‚¬ìš©
                            mergedUsers.push(teacher);
                        }
                    });

                    users = mergedUsers;
                    localStorage.setItem('users', JSON.stringify(users));
                    console.log('âœ… íšŒì› ê´€ë¦¬: ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ (ì‚­ì œëœ íšŒì› ì œì™¸:', deletedUserIds.size + 'ê°œ)');
                }
            }
            ensureDefaultTeacherAccount();
            updateUserStats();
            loadUsersList();
        }

        // íšŒì› í†µê³„ ì—…ë°ì´íŠ¸
        function updateUserStats() {
            const students = users.filter(u => u.role === 'student');
            const parents = users.filter(u => u.role === 'parent');
            const pending = users.filter(u => u.status === 'pending');
            const active = users.filter(u => u.status === 'active');

            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalParents').textContent = parents.length;
            document.getElementById('pendingUsers').textContent = pending.length;
            document.getElementById('activeUsers').textContent = active.length;
        }

        // íšŒì› ëª©ë¡ ë¡œë“œ
        function loadUsersList() {
            const container = document.getElementById('usersList');

            // í•„í„° ì ìš©
            const roleFilter = document.getElementById('userRoleFilter')?.value || 'all';
            const statusFilter = document.getElementById('userStatusFilter')?.value || 'all';

            let filteredUsers = users.filter(user => {
                if (roleFilter !== 'all' && user.role !== roleFilter) return false;
                if (statusFilter !== 'all' && user.status !== statusFilter) return false;
                return true;
            });

            if (filteredUsers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">ğŸ‘¥ ì¡°ê±´ì— ë§ëŠ” íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = filteredUsers.map(user => createUserItem(user)).join('');
        }

        // íšŒì› ëª©ë¡ ì•„ì´í…œ ìƒì„±
        function createUserItem(user) {
            const roleEmoji = {
                'student': 'ğŸ‘¨â€ğŸ“',
                'parent': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',
                'teacher': 'ğŸ‘¨â€ğŸ«'
            };

            const statusClass = {
                'active': 'status-active',
                'pending': 'status-pending',
                'suspended': 'status-suspended'
            };

            const statusText = {
                'active': 'í™œì„±',
                'pending': 'ìŠ¹ì¸ëŒ€ê¸°',
                'suspended': 'ì •ì§€'
            };

            let userInfo = '';
            if (user.role === 'student') {
                userInfo = `${user.name} (${user.userId})`;
            } else if (user.role === 'parent') {
                userInfo = `${user.name} (${user.userId})`;
            } else {
                userInfo = user.name;
            }

            return `
                <div class="user-item">
                    <div class="user-info-section">
                        <div class="user-avatar-mini">${roleEmoji[user.role]}</div>
                        <div class="user-details">
                            <div class="user-name-role">${userInfo}</div>
                            <div class="user-meta">
                                ${getRoleText(user.role)} â€¢ 
                                ê°€ì…: ${formatDate(user.joinDate)} â€¢ 
                                ${user.lastLogin ? `ìµœì¢… ë¡œê·¸ì¸: ${new Date(user.lastLogin).toLocaleString('ko-KR')}` : 'ë¡œê·¸ì¸ ê¸°ë¡ ì—†ìŒ'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-actions">
                        <div class="status-indicator ${statusClass[user.status]}"></div>
                        <span class="badge badge-${user.status === 'active' ? 'approved' : user.status === 'pending' ? 'pending' : 'urgent'}">${statusText[user.status]}</span>
                        
                        ${user.status === 'pending' ? `
                            <button class="btn btn-small" onclick="approveUser('${user.id}')" style="background: #10b981;">
                                âœ… ìŠ¹ì¸
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="rejectUser('${user.id}')">
                                âŒ ê±°ë¶€
                            </button>
                        ` : user.status === 'active' ? `
                            <button class="btn btn-secondary btn-small" onclick="suspendUser('${user.id}')">
                                â¸ï¸ ì •ì§€
                            </button>
                        ` : `
                            <button class="btn btn-small" onclick="activateUser('${user.id}')">
                                ğŸ”„ í™œì„±í™”
                            </button>
                        `}
                        
                        <button class="btn btn-secondary btn-small" onclick="deleteUser('${user.id}')">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
            `;
        }

        // íšŒì› í•„í„°ë§
        function filterUsers() {
            loadUsersList();
        }

        // íšŒì› ìŠ¹ì¸
        function approveUser(userId) {
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex].status = 'active';
                // localStorage ì €ì¥
                localStorage.setItem('users', JSON.stringify(users));
                // Google Sheetsì— ì—…ë°ì´íŠ¸ ì €ì¥
                saveToGoogleSheets('saveUser', { user: users[userIndex] });
                loadUsersList();
                updateUserStats();
                alert('âœ… íšŒì›ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // íšŒì› ê±°ë¶€
        async function rejectUser(userId) {
            if (confirm('âŒ ì •ë§ ì´ íšŒì›ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    const rejectedUser = users[userIndex];
                    rejectedUser.status = 'rejected';
                    users.splice(userIndex, 1);
                    localStorage.setItem('users', JSON.stringify(users));

                    if (firebaseEnabled && firestore) {
                        await deleteDocumentFromFirebase('users', userId);
                    }

                    loadUsersList();
                    updateUserStats();
                    alert('âŒ íšŒì›ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // íšŒì› ì •ì§€
        function suspendUser(userId) {
            if (confirm('â¸ï¸ ì´ íšŒì›ì„ ì •ì§€ì‹œí‚¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].status = 'suspended';
                    // localStorage ì €ì¥
                    localStorage.setItem('users', JSON.stringify(users));
                    // Google Sheetsì— ì—…ë°ì´íŠ¸ ì €ì¥
                    saveToGoogleSheets('saveUser', { user: users[userIndex] });
                    loadUsersList();
                    updateUserStats();
                    alert('â¸ï¸ íšŒì›ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // íšŒì› í™œì„±í™”
        function activateUser(userId) {
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex].status = 'active';
                loadUsersList();
                updateUserStats();
                alert('ğŸ”„ íšŒì›ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // íšŒì› ì‚­ì œ
        async function deleteUser(userId) {
            if (confirm('ğŸ—‘ï¸ ì •ë§ ì´ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex === -1) {
                    alert('âŒ íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const deletedUser = users[userIndex];

                // Firebaseì—ì„œ ë¨¼ì € ì‚­ì œ (ë¡œì»¬ ì‚­ì œ ì „ì—)
                if (firebaseEnabled && firestore) {
                    try {
                        await deleteDocumentFromFirebase('users', userId);
                        console.log('âœ… Firebaseì—ì„œ íšŒì› ì‚­ì œ ì™„ë£Œ:', userId);
                    } catch (error) {
                        console.error('âŒ Firebase íšŒì› ì‚­ì œ ì‹¤íŒ¨:', error);
                        alert('âš ï¸ Firebaseì—ì„œ íšŒì› ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');
                        return; // Firebase ì‚­ì œ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
                    }
                }

                // ë¡œì»¬ ë°°ì—´ì—ì„œ ì‚­ì œ
                users.splice(userIndex, 1);

                // localStorage ì—…ë°ì´íŠ¸ (ì‚­ì œëœ ìƒíƒœ ë°˜ì˜)
                localStorage.setItem('users', JSON.stringify(users));

                // ì‚­ì œëœ íšŒì› IDë¥¼ ì¶”ì í•˜ì—¬ localStorageì— ì €ì¥ (ë‚˜ì¤‘ì— ë™ê¸°í™” ì‹œ ì œì™¸)
                const deletedUserIds = JSON.parse(localStorage.getItem('deletedUserIds') || '[]');
                if (!deletedUserIds.includes(userId)) {
                    deletedUserIds.push(userId);
                    localStorage.setItem('deletedUserIds', JSON.stringify(deletedUserIds));
                }

                // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                loadUsersList();
                updateUserStats();

                alert('ğŸ—‘ï¸ íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                console.log('ğŸ—‘ï¸ íšŒì› ì‚­ì œ ì™„ë£Œ:', deletedUser.name, '(' + deletedUser.userId + ')');
            }
        }

        // ====== ê´€ë¦¬ì íŒ¨ë„ í•¨ìˆ˜ë“¤ ======

        // ê´€ë¦¬ì íŒ¨ë„ ë¡œë“œ
        function loadAdminPanel() {
            updateSystemInfo();
            loadSettings();
        }

        // ì‹œìŠ¤í…œ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSystemInfo() {
            // ì €ì¥ê³µê°„ ì‚¬ìš©ëŸ‰ ê³„ì‚°
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
            const sizeInMB = (totalSize / 1024 / 1024).toFixed(2);

            document.getElementById('storageUsed').textContent = sizeInMB + 'MB';

            // ë§ˆì§€ë§‰ ë°±ì—… ì‹œê°„
            const lastBackup = localStorage.getItem('lastBackup');
            document.getElementById('lastBackup').textContent = lastBackup ?
                new Date(lastBackup).toLocaleDateString('ko-KR') : 'ì—†ìŒ';
        }

        // ìƒˆ êµì‚¬ ê³„ì • ìƒì„±
        function createNewTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            const userId = document.getElementById('newTeacherId').value.trim();
            const password = document.getElementById('newTeacherPassword').value;
            const teacherClass = document.getElementById('newTeacherClass').value.trim();

            if (!name || !userId || !password) {
                showStatus('adminStatus', 'âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì¤‘ë³µ ì•„ì´ë”” í™•ì¸
            const existingUser = users.find(u => u.userId === userId);
            if (existingUser) {
                showStatus('adminStatus', 'âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            // ìƒˆ êµì‚¬ ê³„ì • ìƒì„±
            const newTeacher = {
                id: 'teacher_' + Date.now(),
                role: 'teacher',
                name: name,
                userId: userId,
                password: password,
                email: `${userId}@school.com`,
                class: teacherClass || '',
                status: 'active',
                joinDate: new Date().toISOString().split('T')[0],
                lastLogin: null
            };

            users.push(newTeacher);

            // localStorageì— ì €ì¥
            localStorage.setItem('users', JSON.stringify(users));

            showStatus('adminStatus', `ğŸ‰ ìƒˆ êµì‚¬ ê³„ì • '${name}'ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');

            // í¼ ì´ˆê¸°í™”
            document.getElementById('newTeacherName').value = '';
            document.getElementById('newTeacherId').value = '';
            document.getElementById('newTeacherPassword').value = '';
            document.getElementById('newTeacherClass').value = '';

            // íšŒì›ê´€ë¦¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            if (currentSection === 'users') {
                loadUserManagement();
            }
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData() {
            try {
                const exportData = {
                    announcements: announcements,
                    questions: questions,
                    users: users.filter(u => u.role !== 'teacher'), // êµì‚¬ ê³„ì •ì€ ì œì™¸
                    calendar: calendar,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `redpapa-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                showStatus('adminStatus', 'ğŸ“¤ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                showStatus('adminStatus', 'âŒ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘
        function importData() {
            document.getElementById('importFile').click();
        }

        // íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì²˜ë¦¬
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importData = JSON.parse(e.target.result);

                    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                    if (!importData.version || !importData.exportDate) {
                        throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');
                    }

                    if (confirm('ğŸ”„ ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                        // ë°ì´í„° ë³µì› (êµì‚¬ ê³„ì • ì œì™¸)
                        announcements = importData.announcements || [];
                        questions = importData.questions || [];
                        calendar = importData.calendar || [];

                        // í•™ìƒ/í•™ë¶€ëª¨ ê³„ì •ë§Œ ë³µì›
                        const teacherAccounts = users.filter(u => u.role === 'teacher');
                        const importedUsers = importData.users || [];
                        users = [...teacherAccounts, ...importedUsers];

                        // localStorageì— ì €ì¥
                        saveAllData();

                        showStatus('adminStatus', 'ğŸ“¥ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.', 'success');

                        setTimeout(() => location.reload(), 2000);
                    }
                } catch (error) {
                    showStatus('adminStatus', 'âŒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // ë°±ì—… ìƒì„±
        function backupData() {
            try {
                // localStorageì— ë°±ì—… ì €ì¥
                const backupData = {
                    announcements: announcements,
                    questions: questions,
                    users: users,
                    calendar: calendar,
                    backupDate: new Date().toISOString()
                };

                localStorage.setItem('dataBackup', JSON.stringify(backupData));
                localStorage.setItem('lastBackup', new Date().toISOString());

                updateSystemInfo();
                showStatus('adminStatus', 'ğŸ’¾ ë¡œì»¬ ë°±ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                showStatus('adminStatus', 'âŒ ë°±ì—… ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì‚¬ìš©ì ìºì‹œ ì´ˆê¸°í™” (ë¡œì»¬ ì €ì¥ì†Œì˜ ì‚¬ìš©ì ë°ì´í„°ë§Œ ì‚­ì œ)
        function clearUserCache() {
            if (confirm('ğŸ”„ ë¡œì»¬ ì €ì¥ì†Œì˜ ì‚¬ìš©ì ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€:\n- ë¡œì»¬ì— ì €ì¥ëœ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤\n- Firebaseì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤\n- í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœëŠ” ìœ ì§€ë©ë‹ˆë‹¤')) {
                // ë¡œì»¬ ì €ì¥ì†Œì˜ ì‚¬ìš©ì ë°ì´í„°ë§Œ ì‚­ì œ
                localStorage.removeItem('users');
                sessionStorage.removeItem('currentUser');

                // Google Sheetsì—ì„œ ìµœì‹  ì‚¬ìš©ì ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                if (firebaseEnabled && firestore) {
                    loadFromGoogleSheets('getUsers').then(sheetsUsers => {
                        if (sheetsUsers && sheetsUsers.length > 0) {
                            // Google Sheetsì˜ ì‚¬ìš©ì ë°ì´í„°ë¡œ êµì²´
                            const teacherAccounts = users.filter(u => u.role === 'teacher');
                            users = sheetsUsers;
                            const sheetsUserIds = new Set(users.map(u => u.id));
                            teacherAccounts.forEach(teacher => {
                                if (!sheetsUserIds.has(teacher.id)) {
                                    users.push(teacher);
                                }
                            });
                            localStorage.setItem('users', JSON.stringify(users));

                            showStatus('adminStatus', 'âœ… ì‚¬ìš©ì ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. Firebaseì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');

                            // íšŒì› ê´€ë¦¬ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                            if (currentSection === 'members' || currentSection === 'users') {
                                loadUserManagement();
                            }
                        } else {
                            // Google Sheetsì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‚¬ìš©ìë§Œ ë¡œë“œ
                            loadSampleUsers();
                            localStorage.setItem('users', JSON.stringify(users));
                            showStatus('adminStatus', 'âœ… ì‚¬ìš©ì ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    }).catch(err => {
                        console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
                        loadSampleUsers();
                        localStorage.setItem('users', JSON.stringify(users));
                        showStatus('adminStatus', 'âœ… ì‚¬ìš©ì ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (Firebase ë¡œë“œ ì‹¤íŒ¨)', 'warning');
                    });
                } else {
                    // Google Sheets ì—°ë™ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‚¬ìš©ìë§Œ ë¡œë“œ
                    loadSampleUsers();
                    localStorage.setItem('users', JSON.stringify(users));
                    showStatus('adminStatus', 'âœ… ì‚¬ìš©ì ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            }
        }

        // ëª¨ë“  ë°ì´í„° ì‚­ì œ
        async function clearAllData() {
            if (confirm('ğŸ—‘ï¸ ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                if (confirm('âš ï¸ ë§ˆì§€ë§‰ í™•ì¸: ëª¨ë“  ê³µì§€ì‚¬í•­, ì§ˆë¬¸, íšŒì› ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                    // êµì‚¬ ê³„ì •ë§Œ ìœ ì§€
                    const teacherAccounts = users.filter(u => u.role === 'teacher');

                    announcements = [];
                    questions = [];
                    calendar = [];
                    users = teacherAccounts;

                    saveAllData();

                    if (firebaseEnabled && firestore) {
                        try {
                            await deleteCollectionFromFirebase('announcements');
                            await deleteCollectionFromFirebase('questions');
                            await deleteCollectionFromFirebase('calendar');
                            await deleteCollectionFromFirebase('users');

                            const batch = firestore.batch();
                            teacherAccounts.forEach(teacher => {
                                const ref = firestore.collection('users').doc(teacher.id);
                                batch.set(ref, teacher);
                            });
                            await batch.commit();
                        } catch (error) {
                            console.error('Firebase ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                        }
                    }

                    showStatus('adminStatus', 'ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (êµì‚¬ ê³„ì • ì œì™¸)', 'success');

                    // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    showSection('dashboard');
                }
            }
        }

        // ì„¤ì • ì €ì¥
        function saveSettings() {
            const googleScriptUrl = document.getElementById('googleScriptUrl').value.trim();

            const settings = {
                googleScriptUrl: googleScriptUrl,
                lastUpdated: new Date().toISOString()
            };

            localStorage.setItem('systemSettings', JSON.stringify(settings));
            showStatus('adminStatus', 'ğŸ’¾ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        // ì„¤ì • ë¡œë“œ
        function loadSettings() {
            const savedSettings = localStorage.getItem('systemSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    document.getElementById('googleScriptUrl').value = settings.googleScriptUrl || '';
                } catch (error) {
                    console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
        }

        // Google Sheets ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testGoogleConnection() {
            const url = document.getElementById('googleScriptUrl').value.trim();

            if (!url) {
                showStatus('adminStatus', 'âš ï¸ Google Apps Script URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showStatus('adminStatus', 'ğŸ”„ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘...', 'info');

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    showStatus('adminStatus', 'âœ… Google Sheets ì—°ê²° ì„±ê³µ!', 'success');
                } else {
                    throw new Error(result.error || 'ì—°ê²° ì‹¤íŒ¨');
                }
            } catch (error) {
                showStatus('adminStatus', `âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ëª¨ë“  ë°ì´í„° ì €ì¥
        function saveAllData() {
            localStorage.setItem('announcements', JSON.stringify(announcements));
            localStorage.setItem('questions', JSON.stringify(questions));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('calendar', JSON.stringify(calendar));
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalAnnouncements').textContent = announcements.length;
            document.getElementById('totalComments').textContent = announcements.reduce((sum, ann) => sum + (ann.comments || []).length, 0);
            document.getElementById('totalQuestions').textContent = questions.filter(q => q.status === 'pending').length;
            document.getElementById('totalUsers').textContent = users.length;

            // í˜ì´ì§•ëœ ìµœê·¼ ê³µì§€ì‚¬í•­ í‘œì‹œ
            displayPaginatedAnnouncements();
        }

        // í˜ì´ì§•ëœ ê³µì§€ì‚¬í•­ í‘œì‹œ
        function displayPaginatedAnnouncements() {
            const recentContainer = document.getElementById('recentAnnouncements');
            const paginationContainer = document.getElementById('announcementPagination');

            if (announcements.length === 0) {
                recentContainer.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">ğŸ“­ ì•„ì§ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                paginationContainer.classList.add('hidden');
                return;
            }

            // ê¸´ê¸‰ ê³µì§€ì‚¬í•­ì„ ë§¨ ìƒë‹¨ì—, ê·¸ ë‹¤ìŒ ë‚ ì§œìˆœ ì •ë ¬
            const sortedAnnouncements = announcements.sort((a, b) => {
                // ê¸´ê¸‰ë„ ìš°ì„  ì •ë ¬
                if (a.urgent === 'urgent' && b.urgent !== 'urgent') return -1;
                if (a.urgent !== 'urgent' && b.urgent === 'urgent') return 1;

                // ê°™ì€ ê¸´ê¸‰ë„ë©´ ë‚ ì§œìˆœ ì •ë ¬
                return new Date(b.date) - new Date(a.date);
            });

            // í˜ì´ì§• ê³„ì‚°
            totalPages = Math.ceil(sortedAnnouncements.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageAnnouncements = sortedAnnouncements.slice(startIndex, endIndex);

            // ê³µì§€ì‚¬í•­ í‘œì‹œ
            recentContainer.innerHTML = '';
            currentPageAnnouncements.forEach(announcement => {
                const card = createAnnouncementCard(announcement, true);
                recentContainer.appendChild(card);
            });

            // í˜ì´ì§• ë²„íŠ¼ í‘œì‹œ (5ê°œ ì´ìƒì¼ ë•Œë§Œ)
            if (sortedAnnouncements.length > itemsPerPage) {
                displayPagination();
                paginationContainer.classList.remove('hidden');
            } else {
                paginationContainer.classList.add('hidden');
            }
        }

        // ====== ì•Œë¦¼ ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤ ======

        // ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸
        function updateNotificationBadge() {
            if (!currentUser || currentUser.role === 'teacher') return;

            // ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜ ê³„ì‚°
            const lastReadTime = localStorage.getItem(`lastRead_${currentUser.id}`) || '1970-01-01';
            const newAnnouncements = announcements.filter(ann => ann.date > lastReadTime);

            unreadCount = newAnnouncements.length;

            const badgeElement = document.getElementById('notificationBadge');
            const countElement = document.getElementById('badgeCount');

            if (unreadCount > 0) {
                badgeElement.classList.remove('hidden');
                countElement.textContent = unreadCount > 99 ? '99+' : unreadCount;
            } else {
                badgeElement.classList.add('hidden');
            }
        }

        // ì•Œë¦¼ í™•ì¸
        function showNotifications() {
            // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
            showSection('dashboard');

            // ì½ìŒ í‘œì‹œ
            if (currentUser && currentUser.role !== 'teacher') {
                localStorage.setItem(`lastRead_${currentUser.id}`, new Date().toISOString());
                updateNotificationBadge();
            }
        }

        // ìƒˆ ê³µì§€ì‚¬í•­ ì•Œë¦¼ ì¶”ê°€
        function addNotificationForNewAnnouncement() {
            // í•™ìƒ/í•™ë¶€ëª¨ë“¤ì—ê²Œ ì•Œë¦¼ í‘œì‹œ
            updateNotificationBadge();

            // ë¸Œë¼ìš°ì € ì•Œë¦¼ (ê¶Œí•œì´ ìˆì„ ê²½ìš°)
            if (Notification.permission === 'granted') {
                new Notification('ğŸ“¢ ìƒˆ ê³µì§€ì‚¬í•­', {
                    body: 'ìƒˆë¡œìš´ ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
                    icon: '/icon-192.png'
                });
            }
        }

        // ====== íŒŒì¼ ì²¨ë¶€ í•¨ìˆ˜ë“¤ ======

        // íŒŒì¼ ë“œë˜ê·¸ ì˜¤ë²„ ì²˜ë¦¬
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        // íŒŒì¼ ë“œë˜ê·¸ ë– ë‚¨ ì²˜ë¦¬
        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }

        // íŒŒì¼ ë“œë¡­ ì²˜ë¦¬
        function handleFileDrop(event, type) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');

            const files = event.dataTransfer.files;
            processFiles(files, type);
        }

        // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        function handleFileSelect(event, type) {
            const files = event.target.files;
            processFiles(files, type);
        }

        // íŒŒì¼ ì²˜ë¦¬
        function processFiles(files, type) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/', 'application/pdf', 'application/msword', 'text/'];

            for (let file of files) {
                // íŒŒì¼ í¬ê¸° ê²€ì‚¬
                if (file.size > maxSize) {
                    alert(`âŒ "${file.name}" íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ 10MB)`);
                    continue;
                }

                // íŒŒì¼ íƒ€ì… ê²€ì‚¬
                const isAllowed = allowedTypes.some(allowedType => file.type.startsWith(allowedType));
                if (!isAllowed) {
                    alert(`âŒ "${file.name}" íŒŒì¼ í˜•ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    continue;
                }

                // íŒŒì¼ ì¶”ê°€
                const fileData = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                };

                if (type === 'announcement') {
                    announcementFiles.push(fileData);
                    updateFileList('announcement');
                } else if (type === 'question') {
                    questionFiles.push(fileData);
                    updateFileList('question');
                }
            }
        }

        // íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateFileList(type) {
            const files = type === 'announcement' ? announcementFiles : questionFiles;
            const container = document.getElementById(type === 'announcement' ? 'announcementFileList' : 'questionFileList');

            container.innerHTML = '';

            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                const fileIcon = getFileIcon(file.type);
                const fileSize = formatFileSize(file.size);

                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">${fileIcon}</div>
                        <div>
                            <div class="file-details">${file.name}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                    </div>
                    <button class="file-remove" onclick="removeFile('${type}', '${file.id}')">
                        ğŸ—‘ï¸ ì‚­ì œ
                    </button>
                `;

                container.appendChild(fileItem);
            });
        }

        // íŒŒì¼ ì•„ì´ì½˜ ì–»ê¸°
        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (fileType.includes('pdf')) return 'ğŸ“„';
            if (fileType.includes('word') || fileType.includes('hwp')) return 'ğŸ“';
            if (fileType.startsWith('text/')) return 'ğŸ“„';
            return 'ğŸ“';
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // íŒŒì¼ ì œê±°
        function removeFile(type, fileId) {
            if (type === 'announcement') {
                announcementFiles = announcementFiles.filter(f => f.id != fileId);
                updateFileList('announcement');
            } else if (type === 'question') {
                questionFiles = questionFiles.filter(f => f.id != fileId);
                updateFileList('question');
            }
        }

        // í˜ì´ì§• ë²„íŠ¼ í‘œì‹œ
        function displayPagination() {
            const container = document.getElementById('announcementPagination');
            let paginationHTML = '';

            // ì´ì „ ë²„íŠ¼
            paginationHTML += `
                <button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    â¬…ï¸ ì´ì „
                </button>
            `;

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤ (ìµœëŒ€ 5ê°œ í‘œì‹œ)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                        ${i}
                    </button>
                `;
            }

            // ë‹¤ìŒ ë²„íŠ¼
            paginationHTML += `
                <button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    ë‹¤ìŒ â¡ï¸
                </button>
            `;

            // í˜ì´ì§€ ì •ë³´
            paginationHTML += `
                <span class="pagination-info">
                    ${currentPage} / ${totalPages} í˜ì´ì§€ (ì´ ${announcements.length}ê°œ)
                </span>
            `;

            container.innerHTML = paginationHTML;
        }

        // í˜ì´ì§€ ë³€ê²½
        function changePage(newPage) {
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayPaginatedAnnouncements();
            }
        }

        // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ (ìƒ˜í”Œ ë°ì´í„° ì œê±°ë¨)
        function loadSampleData() {
            // ìƒ˜í”Œ ë°ì´í„° ì—†ìŒ - localStorageì— ì €ì¥ëœ ë°ì´í„°ë§Œ ì‚¬ìš©
            // ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™” (ì´ë¯¸ loadStoredData()ì—ì„œ ì²˜ë¦¬ë¨)
        }

        // ê³µì§€ì‚¬í•­ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function createAnnouncement(event) {
            event.preventDefault();

            if (!currentUser || currentUser.role !== 'teacher') {
                showStatus('announcementStatus', 'âŒ ê³µì§€ì‚¬í•­ ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            const urgent = document.getElementById('announcementUrgent').value;
            const date = document.getElementById('announcementDate').value || new Date().toISOString().split('T')[0];
            const category = document.getElementById('announcementCategory').value;

            const newAnnouncement = {
                id: 'ann_' + Date.now(),
                title: title,
                content: content,
                author: currentUser.name,
                authorEmail: currentUser.email,
                date: date,
                urgent: urgent,
                category: category,
                comments: [],
                attachments: announcementFiles.map(file => ({
                    id: file.id,
                    name: file.name,
                    size: file.size,
                    type: file.type
                }))
            };

            announcements.unshift(newAnnouncement);

            // localStorageì— ë¨¼ì € ë°±ì—… ì €ì¥
            localStorage.setItem('announcements', JSON.stringify(announcements));

            // Firebaseì— ì €ì¥ (awaitë¡œ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°)
            try {
                const saveResult = await saveToGoogleSheets('saveAnnouncement', { announcement: newAnnouncement });
                if (saveResult && saveResult.success) {
                    console.log('âœ… Firebaseì— ê³µì§€ì‚¬í•­ ì €ì¥ ì™„ë£Œ');
                } else {
                    console.warn('âš ï¸ Firebase ì €ì¥ ê²°ê³¼:', saveResult);
                }
            } catch (error) {
                console.error('âŒ Firebase ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                // ì €ì¥ ì‹¤íŒ¨í•´ë„ ë¡œì»¬ì—ëŠ” ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
            }

            // ì•Œë¦¼ ì¶”ê°€
            addNotificationForNewAnnouncement();

            // ë‹¬ë ¥ì— ì¼ì • ì¶”ê°€
            if (date) {
                calendar.push({
                    date: date,
                    title: title,
                    type: 'announcement'
                });
            }

            showStatus('announcementStatus', 'ğŸ‰ ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            document.getElementById('newAnnouncementForm').reset();

            // íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
            announcementFiles = [];
            updateFileList('announcement');

            // í˜ì´ì§€ë¥¼ 1í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
            currentPage = 1;
            currentManagementPage = 1;

            loadAnnouncements();
            updateDashboard();
        }

        function loadAnnouncements() {
            displayPaginatedAnnouncementsList();
        }

        // ê³µì§€ì‚¬í•­ ê´€ë¦¬ í˜ì´ì§€ì˜ í˜ì´ì§•ëœ ëª©ë¡ í‘œì‹œ
        function displayPaginatedAnnouncementsList() {
            const container = document.getElementById('announcementsList');
            const paginationContainer = document.getElementById('announcementManagementPagination');

            container.innerHTML = '';

            if (announcements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">ğŸ“­ ì•„ì§ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                paginationContainer.classList.add('hidden');
                return;
            }

            // ê¸´ê¸‰ ê³µì§€ì‚¬í•­ì„ ë§¨ ìƒë‹¨ì—, ê·¸ ë‹¤ìŒ ë‚ ì§œìˆœ ì •ë ¬
            const sortedAnnouncements = announcements.sort((a, b) => {
                // ê¸´ê¸‰ë„ ìš°ì„  ì •ë ¬
                if (a.urgent === 'urgent' && b.urgent !== 'urgent') return -1;
                if (a.urgent !== 'urgent' && b.urgent === 'urgent') return 1;

                // ê°™ì€ ê¸´ê¸‰ë„ë©´ ë‚ ì§œìˆœ ì •ë ¬
                return new Date(b.date) - new Date(a.date);
            });

            // í˜ì´ì§• ê³„ì‚°
            managementTotalPages = Math.ceil(sortedAnnouncements.length / managementItemsPerPage);
            const startIndex = (currentManagementPage - 1) * managementItemsPerPage;
            const endIndex = startIndex + managementItemsPerPage;
            const currentPageAnnouncements = sortedAnnouncements.slice(startIndex, endIndex);

            // ê³µì§€ì‚¬í•­ í‘œì‹œ
            currentPageAnnouncements.forEach(announcement => {
                const card = createAnnouncementCard(announcement);
                container.appendChild(card);
            });

            // í˜ì´ì§• ë²„íŠ¼ í‘œì‹œ (5ê°œ ì´ìƒì¼ ë•Œë§Œ)
            if (sortedAnnouncements.length > managementItemsPerPage) {
                displayManagementPagination();
                paginationContainer.classList.remove('hidden');
            } else {
                paginationContainer.classList.add('hidden');
            }
        }

        // ê³µì§€ì‚¬í•­ ê´€ë¦¬ í˜ì´ì§• ë²„íŠ¼ í‘œì‹œ
        function displayManagementPagination() {
            const container = document.getElementById('announcementManagementPagination');
            let paginationHTML = '';

            // ì´ì „ ë²„íŠ¼
            paginationHTML += `
                <button class="pagination-btn" onclick="changeManagementPage(${currentManagementPage - 1})" ${currentManagementPage === 1 ? 'disabled' : ''}>
                    â¬…ï¸ ì´ì „
                </button>
            `;

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤ (ìµœëŒ€ 5ê°œ í‘œì‹œ)
            let startPage = Math.max(1, currentManagementPage - 2);
            let endPage = Math.min(managementTotalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === currentManagementPage ? 'active' : ''}" onclick="changeManagementPage(${i})">
                        ${i}
                    </button>
                `;
            }

            // ë‹¤ìŒ ë²„íŠ¼
            paginationHTML += `
                <button class="pagination-btn" onclick="changeManagementPage(${currentManagementPage + 1})" ${currentManagementPage === managementTotalPages ? 'disabled' : ''}>
                    ë‹¤ìŒ â¡ï¸
                </button>
            `;

            // í˜ì´ì§€ ì •ë³´
            paginationHTML += `
                <span class="pagination-info">
                    ${currentManagementPage} / ${managementTotalPages} í˜ì´ì§€ (ì´ ${announcements.length}ê°œ)
                </span>
            `;

            container.innerHTML = paginationHTML;
        }

        // ê³µì§€ì‚¬í•­ ê´€ë¦¬ í˜ì´ì§€ ë³€ê²½
        function changeManagementPage(newPage) {
            if (newPage >= 1 && newPage <= managementTotalPages) {
                currentManagementPage = newPage;
                displayPaginatedAnnouncementsList();
            }
        }

        function createAnnouncementCard(announcement, isPreview = false) {
            const card = document.createElement('div');
            card.className = `announcement-card ${announcement.urgent === 'urgent' ? 'urgent' : ''}`;

            const urgentIcon = announcement.urgent === 'urgent' ? 'ğŸš¨ ' : '';
            const categoryIcon = getCategoryIcon(announcement.category);

            card.innerHTML = `
                <div class="announcement-title">
                    ${urgentIcon}${categoryIcon} ${announcement.title}
                </div>
                <div class="announcement-content">${announcement.content.replace(/\n/g, '<br>')}</div>
                ${announcement.attachments && announcement.attachments.length > 0 ? `
                    <div class="attachments-section">
                        <div class="attachments-title">ğŸ“ ì²¨ë¶€íŒŒì¼ (${announcement.attachments.length}ê°œ)</div>
                        <div class="attachments-list">
                            ${announcement.attachments.map(file => `
                                <div class="attachment-item">
                                    ${getFileIcon(file.type)} ${file.name} 
                                    <span class="file-size">(${formatFileSize(file.size)})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                <div class="announcement-meta">
                    <div>
                        <strong>${announcement.author}</strong> â€¢ ${formatDate(announcement.date)}
                    </div>
                    <div>
                        <span class="badge badge-${announcement.urgent}">${announcement.urgent === 'urgent' ? 'ê¸´ê¸‰' : 'ì¼ë°˜'}</span>
                        ${announcement.comments.length > 0 ? `<span style="margin-left: 10px;">ğŸ’¬ ${announcement.comments.length}</span>` : ''}
                    </div>
                </div>
                ${!isPreview ? `
                    <div class="announcement-actions">
                        <button class="btn btn-small" onclick="toggleComments('${announcement.id}')">
                            ğŸ’¬ ëŒ“ê¸€ ${announcement.comments.length > 0 ? `(${announcement.comments.length})` : ''}
                        </button>
                        ${currentUser && currentUser.role === 'teacher' ? `
                            <button class="btn btn-secondary btn-small" onclick="editAnnouncement('${announcement.id}')">
                                âœï¸ ìˆ˜ì •
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="deleteAnnouncement('${announcement.id}')">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        ` : ''}
                    </div>
                    <div class="comments-section hidden" id="comments-${announcement.id}">
                        <div id="comments-list-${announcement.id}">
                            ${announcement.comments.map(comment => `
                                <div class="comment-item">
                                    <div class="comment-author">${comment.author}</div>
                                    <div class="comment-content">${comment.content}</div>
                                    <div class="comment-time">${comment.date}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 15px;">
                            <textarea placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." id="comment-input-${announcement.id}" style="margin-bottom: 10px;"></textarea>
                            <button class="btn btn-small" onclick="addComment('${announcement.id}')">
                                ğŸ’Œ ëŒ“ê¸€ ì‘ì„±
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;

            return card;
        }

        function getCategoryIcon(category) {
            const icons = {
                'general': 'ğŸ“',
                'academic': 'ğŸ“š',
                'event': 'ğŸ‰',
                'safety': 'âš ï¸',
                'notice': 'ğŸ“¢'
            };
            return icons[category] || 'ğŸ“';
        }

        function toggleComments(announcementId) {
            const commentsSection = document.getElementById(`comments-${announcementId}`);
            commentsSection.classList.toggle('hidden');
        }

        function addComment(announcementId) {
            const textarea = document.getElementById(`comment-input-${announcementId}`);
            const content = textarea.value.trim();

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const announcement = announcements.find(a => a.id === announcementId);
            if (!announcement) return;

            const newComment = {
                author: currentUser.name,
                content: content,
                date: new Date().toLocaleString('ko-KR')
            };

            announcement.comments.push(newComment);
            textarea.value = '';

            // ëŒ“ê¸€ ëª©ë¡ ì—…ë°ì´íŠ¸
            loadAnnouncements();

            // ëŒ“ê¸€ ì„¹ì…˜ ë‹¤ì‹œ ì—´ê¸°
            setTimeout(() => {
                toggleComments(announcementId);
            }, 100);
        }

        // ì§ˆë¬¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function createQuestion(event) {
            event.preventDefault();

            const title = document.getElementById('questionTitle').value;
            const content = document.getElementById('questionContent').value;
            const type = document.getElementById('questionType').value;
            const isPrivate = document.getElementById('questionPrivate').checked;

            const newQuestion = {
                id: 'q_' + Date.now(),
                title: title,
                content: content,
                author: currentUser.name,
                authorEmail: currentUser.email,
                type: type,
                date: new Date().toISOString().split('T')[0],
                status: 'pending',
                private: isPrivate,
                answer: '',
                answerDate: '',
                attachments: questionFiles.map(file => ({
                    id: file.id,
                    name: file.name,
                    size: file.size,
                    type: file.type
                }))
            };

            questions.unshift(newQuestion);

            // Google Sheetsì— ì €ì¥ (ë¹„ë™ê¸°)
            saveToGoogleSheets('saveQuestion', { question: newQuestion });

            // localStorageì—ë„ ë°±ì—… ì €ì¥
            localStorage.setItem('questions', JSON.stringify(questions));

            // ê´€ë¦¬ì(êµì‚¬)ì—ê²Œ ìƒˆ ì§ˆë¬¸ ì•Œë¦¼ (í•™ìƒ/í•™ë¶€ëª¨ê°€ ì§ˆë¬¸ì„ ë³´ë‚¼ ë•Œ)
            if (currentUser.role === 'student' || currentUser.role === 'parent') {
                // êµì‚¬ì—ê²Œ ì•Œë¦¼ì´ ê°€ë„ë¡ ì²˜ë¦¬ (ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë„ë¡)
                console.log('ğŸ“¬ ìƒˆ ì§ˆë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.');
            }

            showStatus('questionStatus', 'ğŸš€ ì§ˆë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            document.getElementById('newQuestionForm').reset();

            // íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
            questionFiles = [];
            updateFileList('question');
            loadQuestions();
            updateDashboard();
        }

        function loadQuestions() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '';

            // ì‚¬ìš©ìë³„ ì§ˆë¬¸ í•„í„°ë§
            let userQuestions = questions;
            if (currentUser?.role === 'student' || currentUser?.role === 'parent') {
                // í•™ìƒ/í•™ë¶€ëª¨ëŠ” ë³¸ì¸ ì§ˆë¬¸ë§Œ ë³´ê¸°
                userQuestions = questions.filter(q => q.authorEmail === currentUser.email || q.author === currentUser.name);
            }
            // êµì‚¬ëŠ” ëª¨ë“  ì§ˆë¬¸ ë³´ê¸°

            if (userQuestions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">ğŸ’¬ ì•„ì§ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            userQuestions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(question => {
                    const card = createQuestionCard(question);
                    container.appendChild(card);
                });
        }

        function createQuestionCard(question) {
            const card = document.createElement('div');
            card.className = 'announcement-card';

            const typeIcon = getQuestionTypeIcon(question.type);
            const statusBadge = question.status === 'answered' ?
                '<span class="badge badge-approved">ë‹µë³€ ì™„ë£Œ</span>' :
                '<span class="badge badge-pending">ë‹µë³€ ëŒ€ê¸°</span>';

            card.innerHTML = `
                <div class="announcement-title">
                    ${typeIcon} ${question.title}
                    ${question.private ? ' ğŸ”’' : ''}
                </div>
                <div class="announcement-content">${question.content}</div>
                ${question.answer ? `
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 3px solid #0ea5e9;">
                        <div style="font-weight: 600; color: #0369a1; margin-bottom: 8px;">ğŸ“ ì„ ìƒë‹˜ ë‹µë³€</div>
                        <div style="color: #0f172a;">${question.answer}</div>
                        <div style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">${question.answerDate}</div>
                    </div>
                ` : ''}
                <div class="announcement-meta">
                    <div>
                        <strong>${question.author}</strong> â€¢ ${formatDate(question.date)} â€¢ ${getQuestionTypeText(question.type)}
                    </div>
                    <div>
                        ${statusBadge}
                    </div>
                </div>
                ${currentUser && currentUser.role === 'teacher' && question.status === 'pending' ? `
                    <div class="announcement-actions">
                        <button class="btn btn-small" onclick="answerQuestion('${question.id}')">
                            ğŸ’¬ ë‹µë³€í•˜ê¸°
                        </button>
                    </div>
                ` : ''}
            `;

            return card;
        }

        function getQuestionTypeIcon(type) {
            const icons = {
                'academic': 'ğŸ“š',
                'life': 'ğŸ«',
                'career': 'ğŸ¯',
                'behavior': 'ğŸ‘¥',
                'other': 'â“'
            };
            return icons[type] || 'â“';
        }

        function getQuestionTypeText(type) {
            const texts = {
                'academic': 'í•™ìŠµê´€ë ¨',
                'life': 'í•™êµìƒí™œ',
                'career': 'ì§„ë¡œìƒë‹´',
                'behavior': 'ìƒí™œì§€ë„',
                'other': 'ê¸°íƒ€'
            };
            return texts[type] || 'ê¸°íƒ€';
        }

        function answerQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (!question) return;

            const answer = prompt(`"${question.title}" ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:`, '');
            if (answer && answer.trim()) {
                question.answer = answer.trim();
                question.answerDate = new Date().toLocaleString('ko-KR');
                question.status = 'answered';

                loadQuestions();
                updateDashboard();
            }
        }

        // ë‹¬ë ¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');

            // í˜„ì¬ ì›” í‘œì‹œ
            currentMonthElement.textContent = `${currentDate.getFullYear()}ë…„ ${currentDate.getMonth() + 1}ì›”`;

            // ë‹¬ë ¥ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
            calendarGrid.innerHTML = '';

            // ìš”ì¼ í—¤ë” ì¶”ê°€
            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayHeaderColors = ['#ef4444', '#374151', '#374151', '#374151', '#374151', '#374151', '#0ea5e9'];

            dayHeaders.forEach((day, index) => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                header.style.color = dayHeaderColors[index];
                header.style.fontWeight = (index === 0 || index === 6) ? '600' : '500';
                calendarGrid.appendChild(header);
            });

            // ë‹¬ë ¥ ë‚ ì§œ ìƒì„±
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();
            const todayString = today.toISOString().split('T')[0];

            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                // ë‹¤ë¥¸ ì›” ë‚ ì§œ ì²˜ë¦¬
                if (currentDay.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }

                const dateString = currentDay.toISOString().split('T')[0];
                const dayOfWeek = currentDay.getDay(); // 0: ì¼ìš”ì¼, 6: í† ìš”ì¼

                // ìš”ì¼ë³„ ìƒ‰ìƒ ì ìš©
                if (dayOfWeek === 0) { // ì¼ìš”ì¼
                    dayElement.classList.add('sunday');
                } else if (dayOfWeek === 6) { // í† ìš”ì¼
                    dayElement.classList.add('saturday');
                }

                // ê³µíœ´ì¼ í™•ì¸
                if (holidays.includes(dateString)) {
                    dayElement.classList.add('holiday');
                }

                // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
                if (dateString === todayString) {
                    dayElement.classList.add('today');
                }

                // ì´ë²¤íŠ¸ í™•ì¸
                const dayEvents = calendar.filter(event => event.date === dateString);
                if (dayEvents.length > 0) {
                    dayElement.classList.add('has-event');
                }

                dayElement.innerHTML = `
                    <div class="calendar-day-number">${currentDay.getDate()}</div>
                    ${dayEvents.map(event => `
                        <div class="calendar-event" onclick="showEventDetails('${event.date}', '${event.title}')">${event.title}</div>
                    `).join('')}
                `;

                dayElement.addEventListener('click', () => showDayEvents(dateString));
                calendarGrid.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        function showDayEvents(dateString) {
            const events = calendar.filter(event => event.date === dateString);
            const container = document.getElementById('selectedDateEvents');

            if (events.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="section" style="margin-bottom: 0;">
                    <h3 style="color: #2d3748; margin-bottom: 15px; font-weight: 600;">
                        ğŸ“… ${formatDate(dateString)} ì¼ì •
                    </h3>
                    ${events.map(event => `
                        <div class="announcement-card">
                            <div class="announcement-title">${event.title}</div>
                            <div class="announcement-meta">
                                <span>ì¼ì • ìœ í˜•: ${getEventTypeText(event.type)}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getEventTypeText(type) {
            const texts = {
                'announcement': 'ê³µì§€ì‚¬í•­',
                'event': 'í•™êµ í–‰ì‚¬',
                'academic': 'í•™ìŠµ ê´€ë ¨',
                'notice': 'ì•Œë¦¼'
            };
            return texts[type] || type;
        }

        // ê²€ìƒ‰ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const searchType = document.getElementById('searchType').value;
            const searchDate = document.getElementById('searchDate').value;
            const container = document.getElementById('searchResults');

            if (!searchTerm && !searchDate) {
                container.innerHTML = `
                    <div style="text-align: center; color: #9ca3af; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;">ğŸ”</div>
                        <p>ğŸ” ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            let results = [];

            // ê³µì§€ì‚¬í•­ ê²€ìƒ‰
            if (searchType === 'all' || searchType === 'announcements') {
                const announcementResults = announcements.filter(item => {
                    const matchesText = searchTerm === '' ||
                        item.title.toLowerCase().includes(searchTerm) ||
                        item.content.toLowerCase().includes(searchTerm);
                    const matchesDate = searchDate === '' || item.date.startsWith(searchDate);
                    return matchesText && matchesDate;
                }).map(item => ({ ...item, type: 'announcement' }));
                results.push(...announcementResults);
            }

            // ì§ˆë¬¸ ê²€ìƒ‰
            if (searchType === 'all' || searchType === 'questions') {
                const questionResults = questions.filter(item => {
                    const matchesText = searchTerm === '' ||
                        item.title.toLowerCase().includes(searchTerm) ||
                        item.content.toLowerCase().includes(searchTerm);
                    const matchesDate = searchDate === '' || item.date.startsWith(searchDate);
                    return matchesText && matchesDate;
                }).map(item => ({ ...item, type: 'question' }));
                results.push(...questionResults);
            }

            // ì¼ì • ê²€ìƒ‰
            if (searchType === 'all' || searchType === 'calendar') {
                const calendarResults = calendar.filter(item => {
                    const matchesText = searchTerm === '' ||
                        item.title.toLowerCase().includes(searchTerm);
                    const matchesDate = searchDate === '' || item.date.startsWith(searchDate);
                    return matchesText && matchesDate;
                }).map(item => ({ ...item, type: 'calendar' }));
                results.push(...calendarResults);
            }

            // ê²°ê³¼ í‘œì‹œ
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #9ca3af; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;">ğŸ˜…</div>
                        <p>ğŸ˜… ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
            } else {
                results.sort((a, b) => new Date(b.date) - new Date(a.date));
                container.innerHTML = `
                    <h3 style="color: #2d3748; margin-bottom: 20px; font-weight: 600;">
                        ğŸ” ê²€ìƒ‰ ê²°ê³¼ (${results.length}ê°œ)
                    </h3>
                    ${results.map(item => createSearchResultCard(item)).join('')}
                `;
            }
        }

        function createSearchResultCard(item) {
            const typeIcon = item.type === 'announcement' ? 'ğŸ“¢' :
                item.type === 'question' ? 'â“' : 'ğŸ“…';
            const typeText = item.type === 'announcement' ? 'ê³µì§€ì‚¬í•­' :
                item.type === 'question' ? 'ì§ˆë¬¸/ìƒë‹´' : 'ì¼ì •';

            return `
                <div class="announcement-card">
                    <div class="announcement-title">
                        ${typeIcon} ${item.title}
                    </div>
                    <div class="announcement-content">
                        ${item.content ? item.content.substring(0, 200) + (item.content.length > 200 ? '...' : '') : ''}
                    </div>
                    <div class="announcement-meta">
                        <div>
                            <strong>${item.author || 'ì‹œìŠ¤í…œ'}</strong> â€¢ ${formatDate(item.date)}
                        </div>
                        <div>
                            <span class="badge badge-normal">${typeText}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.classList.remove('hidden');

            setTimeout(() => {
                element.classList.add('hidden');
            }, 3000);
        }


        // í¸ì˜ ê¸°ëŠ¥ë“¤
        function editAnnouncement(announcementId) {
            const announcement = announcements.find(a => a.id === announcementId);
            if (!announcement) return;

            // ê°„ë‹¨í•œ í¸ì§‘ ê¸°ëŠ¥ (ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ í¸ì§‘ í¼ì„ ì‚¬ìš©)
            const newTitle = prompt('ì œëª© ìˆ˜ì •:', announcement.title);
            if (newTitle && newTitle.trim()) {
                announcement.title = newTitle.trim();
                loadAnnouncements();
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (confirm('ì •ë§ ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë¡œì»¬ì—ì„œ ì‚­ì œ
                announcements = announcements.filter(a => a.id !== announcementId);
                localStorage.setItem('announcements', JSON.stringify(announcements));

                // Firebaseì—ì„œë„ ì‚­ì œ
                if (firebaseEnabled && firestore) {
                    try {
                        await deleteDocumentFromFirebase('announcements', announcementId);
                        console.log('âœ… Firebaseì—ì„œ ê³µì§€ì‚¬í•­ ì‚­ì œ ì™„ë£Œ');
                    } catch (error) {
                        console.error('âŒ Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                    }
                }

                loadAnnouncements();
                updateDashboard();
            }
        }

        function showEventDetails(date, title) {
            alert(`${formatDate(date)}\n${title}`);
        }

        // ====== PWA Service Worker ë“±ë¡ ======

        // Service Worker ë“±ë¡ (ì‹¤ì œ í˜¸ìŠ¤íŒ… í™˜ê²½ì—ì„œë§Œ - sw.js íŒŒì¼ì´ ì¡´ì¬í•  ë•Œ)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                // sw.js íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ ë“±ë¡
                fetch('./sw.js', { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            // sw.js íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ë“±ë¡
                            return navigator.serviceWorker.register('./sw.js');
                        } else {
                            throw new Error('sw.js íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    })
                    .then(function (registration) {
                        console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);

                        // ì—…ë°ì´íŠ¸ í™•ì¸
                        registration.addEventListener('updatefound', function () {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function () {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateAvailable();
                                }
                            });
                        });
                    })
                    .catch(function (error) {
                        console.log('ğŸ“± PWA ê¸°ëŠ¥: ì‹¤ì œ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (sw.js íŒŒì¼ í•„ìš”)');
                    });
            });
        } else {
            console.log('ğŸ“± ì´ ë¸Œë¼ìš°ì €ëŠ” Service Workerë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // ì•± ì—…ë°ì´íŠ¸ ì•Œë¦¼
        function showUpdateAvailable() {
            if (confirm('ğŸ”„ ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.reload();
            }
        }

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
        let deferredPrompt;

        // PWA ì„¤ì¹˜ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
        function isPWAInstalled() {
            // 1. standalone ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ (Chrome, Edge ë“±)
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return true;
            }

            // 2. iOS Safariì—ì„œ í™ˆ í™”ë©´ì— ì¶”ê°€ëœ ê²½ìš°
            if (window.navigator.standalone === true) {
                return true;
            }

            // 3. localStorageì— ì„¤ì¹˜ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš°
            const installRecord = localStorage.getItem('pwa_installed');
            if (installRecord === 'true') {
                return true;
            }

            return false;
        }

        window.addEventListener('beforeinstallprompt', function (e) {
            // ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° í”„ë¡¬í”„íŠ¸ë¥¼ ë¬´ì‹œ
            if (isPWAInstalled()) {
                console.log('ğŸ“± PWAê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì–´ í”„ë¡¬í”„íŠ¸ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                e.preventDefault();
                return;
            }

            console.log('ğŸ“± PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì¤€ë¹„ë¨');
            e.preventDefault();
            deferredPrompt = e;

            // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (ì„ íƒì‚¬í•­)
            showInstallButton();
        });

        // ì•± ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ
        function showInstallButton() {
            // ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° ë²„íŠ¼ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            if (isPWAInstalled()) {
                console.log('ğŸ“± PWAê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì–´ ì„¤ì¹˜ ë²„íŠ¼ì„ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            // í—¤ë”ì— ì„¤ì¹˜ ë²„íŠ¼ ì¶”ê°€ (êµì‚¬ë§Œ)
            if (currentUser && currentUser.role === 'teacher') {
                const header = document.querySelector('.header-content');
                if (header && !document.getElementById('installBtn')) {
                    const installBtn = document.createElement('button');
                    installBtn.id = 'installBtn';
                    installBtn.textContent = 'ğŸ“± ì•± ì„¤ì¹˜';
                    installBtn.className = 'btn btn-secondary';
                    installBtn.style.cssText = 'margin-top: 10px; font-size: 0.9rem;';
                    installBtn.onclick = installApp;
                    header.appendChild(installBtn);
                }
            }
        }

        // ì•± ì„¤ì¹˜ ì‹¤í–‰
        function installApp() {
            if (isPWAInstalled()) {
                alert('âœ… ì´ë¯¸ ì•±ì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤!');
                document.getElementById('installBtn')?.remove();
                return;
            }

            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function (choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('âœ… ì‚¬ìš©ìê°€ ì•± ì„¤ì¹˜ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤');
                        // ì„¤ì¹˜ ê¸°ë¡ ì €ì¥
                        localStorage.setItem('pwa_installed', 'true');
                        document.getElementById('installBtn')?.remove();
                    } else {
                        console.log('âŒ ì‚¬ìš©ìê°€ ì•± ì„¤ì¹˜ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('âš ï¸ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ "ì•± ì„¤ì¹˜"ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        }

        // ì„¤ì¹˜ ì™„ë£Œ ì´ë²¤íŠ¸
        window.addEventListener('appinstalled', function (e) {
            console.log('ğŸ‰ PWA ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
            // ì„¤ì¹˜ ê¸°ë¡ ì €ì¥
            localStorage.setItem('pwa_installed', 'true');
            document.getElementById('installBtn')?.remove();
            // deferredPrompt ì´ˆê¸°í™”
            deferredPrompt = null;
        });


        // ì˜¤í”„ë¼ì¸/ì˜¨ë¼ì¸ ìƒíƒœ ê°ì§€
        window.addEventListener('online', function () {
            console.log('ğŸŒ ì˜¨ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤');
            showNetworkStatus('âœ… ì¸í„°ë„·ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        });

        window.addEventListener('offline', function () {
            console.log('ğŸ“± ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤');
            showNetworkStatus('ğŸ“± ì˜¤í”„ë¼ì¸ ëª¨ë“œì…ë‹ˆë‹¤', 'info');
        });

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì•Œë¦¼
        function showNetworkStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 250px;
                text-align: center;
            `;

            document.body.appendChild(statusDiv);

            setTimeout(function () {
                statusDiv.remove();
            }, 3000);
        }

        // ====== Firebase ì—°ë™ í•¨ìˆ˜ë“¤ ======

        // Firebaseì— ë°ì´í„° ì €ì¥
        async function saveToGoogleSheets(action, data) {
            if (!firebaseEnabled || !firestore) {
                console.warn('âš ï¸ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return { success: false, error: 'firebase_not_initialized' };
            }

            try {
                switch (action) {
                    case 'saveAnnouncement':
                        if (!data.announcement) throw new Error('announcement ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        // createdAt íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ (ì—†ìœ¼ë©´)
                        const announcementData = {
                            ...data.announcement,
                            createdAt: data.announcement.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        await firestore.collection('announcements').doc(data.announcement.id).set(announcementData, { merge: false });
                        break;
                    case 'saveQuestion':
                        if (!data.question) throw new Error('question ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        await firestore.collection('questions').doc(data.question.id).set(data.question);
                        break;
                    case 'saveUser':
                        if (!data.user) throw new Error('user ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        // status í•„ë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë³´ì¥ (íšŒì›ê°€ì… ì‹œ pending ìƒíƒœ ìœ ì§€)
                        const userDataForSave = {
                            ...data.user,
                            status: data.user.status || 'pending' // ëª…ì‹œì ìœ¼ë¡œ status ë³´ì¥
                        };
                        await firestore.collection('users').doc(data.user.id).set(userDataForSave);
                        console.log('âœ… ì‚¬ìš©ì ì €ì¥ ì™„ë£Œ (status:', userDataForSave.status + ')');
                        break;
                    case 'saveCalendar':
                        if (!data.calendar) throw new Error('calendar ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        await firestore.collection('calendar').doc(data.calendar.id || ('cal_' + Date.now())).set(data.calendar);
                        break;
                    default:
                        throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ì €ì¥ ì•¡ì…˜: ' + action);
                }

                console.log('âœ… Firebase ì €ì¥ ì„±ê³µ:', action);
                return { success: true };
            } catch (error) {
                console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                return { success: false, error: error.message };
            }
        }

        // Google Sheetsì—ì„œ ë°ì´í„° ë¡œë“œ
        async function loadFromGoogleSheets(action) {
            if (!firebaseEnabled || !firestore) {
                console.warn('âš ï¸ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return null;
            }

            try {
                let collectionName = '';
                switch (action) {
                    case 'getAnnouncements':
                        collectionName = 'announcements';
                        break;
                    case 'getQuestions':
                        collectionName = 'questions';
                        break;
                    case 'getUsers':
                        collectionName = 'users';
                        break;
                    case 'getCalendar':
                        collectionName = 'calendar';
                        break;
                    default:
                        throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ë¡œë“œ ì•¡ì…˜: ' + action);
                }

                const snapshot = await firestore.collection(collectionName).get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('âœ… Firebase ë¡œë“œ ì„±ê³µ:', action, data.length + 'ê°œ');
                return data;
            } catch (error) {
                console.error('âŒ Firebase ë¡œë“œ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        async function deleteCollectionFromFirebase(collectionName) {
            if (!firebaseEnabled || !firestore) return;
            const snapshot = await firestore.collection(collectionName).get();
            const batch = firestore.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }

        async function deleteDocumentFromFirebase(collectionName, docId) {
            if (!firebaseEnabled || !firestore) return;
            try {
                await firestore.collection(collectionName).doc(docId).delete();
            } catch (error) {
                console.error(`âŒ Firebase ë¬¸ì„œ ì‚­ì œ ì‹¤íŒ¨ (${collectionName}/${docId}):`, error);
            }
        }

        // ì•± ì‹œì‘ì‹œ Google Sheetsì—ì„œ ë°ì´í„° ë™ê¸°í™”
        async function syncWithGoogleSheets() {
            if (!firebaseEnabled || !firestore) {
                console.log('ğŸ“± Firebase ì—°ë™ì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë¡œì»¬ ë°ì´í„°ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                return;
            }

            try {
                console.log('ğŸ”„ Google Sheets ë™ê¸°í™” ì‹œì‘...');

                // ê³µì§€ì‚¬í•­ ë™ê¸°í™” - Google Sheets ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬ ë°ì´í„° ìœ ì§€
                const sheetsAnnouncements = await loadFromGoogleSheets('getAnnouncements');
                if (sheetsAnnouncements !== null) {
                    // Google Sheetsì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìœ¼ë©´ (ë¹ˆ ë°°ì—´ì´ì–´ë„) ì‚¬ìš©
                    if (sheetsAnnouncements.length > 0) {
                        const beforeCount = announcements.length;
                        const beforeIds = new Set(announcements.map(a => a.id));
                        announcements = sheetsAnnouncements;
                        localStorage.setItem('announcements', JSON.stringify(announcements));

                        // ìƒˆ ê³µì§€ì‚¬í•­ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸ (í•™ìƒ/í•™ë¶€ëª¨ì—ê²Œ ì•Œë¦¼)
                        const newAnnouncements = announcements.filter(a => !beforeIds.has(a.id));
                        if (newAnnouncements.length > 0 && (currentUser?.role === 'student' || currentUser?.role === 'parent')) {
                            newAnnouncements.forEach(ann => {
                                console.log('ğŸ“¢ ìƒˆ ê³µì§€ì‚¬í•­:', ann.title);
                                addNotificationForNewAnnouncement();
                            });
                        }

                        console.log('ğŸ“‹ ê³µì§€ì‚¬í•­ ë™ê¸°í™” ì™„ë£Œ (Google Sheets):', announcements.length + 'ê°œ');
                        if (newAnnouncements.length > 0) {
                            console.log(`ğŸ“¢ ìƒˆ ê³µì§€ì‚¬í•­ ${newAnnouncements.length}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                    } else {
                        // Google Sheetsê°€ ë¹„ì–´ìˆìœ¼ë©´ ë¡œì»¬ ë°ì´í„°ë¥¼ ìœ ì§€ (ë®ì–´ì“°ê¸° ë°©ì§€)
                        if (announcements.length === 0) {
                            console.log('ğŸ“‹ ê³µì§€ì‚¬í•­: Google Sheets ë° ë¡œì»¬ ë°ì´í„° ì—†ìŒ');
                        } else {
                            console.log('ğŸ“‹ ê³µì§€ì‚¬í•­: Google Sheetsê°€ ë¹„ì–´ìˆì–´ ë¡œì»¬ ë°ì´í„° ìœ ì§€ (' + announcements.length + 'ê°œ)');
                        }
                    }
                } else {
                    // Google Sheets ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„° ìœ ì§€
                    console.log('ğŸ“‹ ê³µì§€ì‚¬í•­: Google Sheets ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                }

                // ì§ˆë¬¸ ë™ê¸°í™” - Google Sheets ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬ ë°ì´í„° ìœ ì§€
                const sheetsQuestions = await loadFromGoogleSheets('getQuestions');
                if (sheetsQuestions !== null) {
                    // Google Sheetsì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìœ¼ë©´ (ë¹ˆ ë°°ì—´ì´ì–´ë„) ì‚¬ìš©
                    if (sheetsQuestions.length > 0) {
                        const beforeCount = questions.length;
                        const beforeIds = new Set(questions.map(q => q.id));
                        questions = sheetsQuestions;
                        localStorage.setItem('questions', JSON.stringify(questions));

                        // ìƒˆ ì§ˆë¬¸ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼)
                        const newQuestions = questions.filter(q => !beforeIds.has(q.id));
                        if (newQuestions.length > 0 && currentUser?.role === 'teacher') {
                            newQuestions.forEach(q => {
                                console.log('ğŸ“¬ ìƒˆ ì§ˆë¬¸:', q.title, '- ì‘ì„±ì:', q.author);
                                // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
                                updateDashboard();
                            });
                            if (newQuestions.length === 1) {
                                alert(`ğŸ“¬ ìƒˆ ì§ˆë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: ${newQuestions[0].title}`);
                            } else {
                                alert(`ğŸ“¬ ìƒˆ ì§ˆë¬¸ ${newQuestions.length}ê°œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            }
                        }

                        console.log('â“ ì§ˆë¬¸ ë™ê¸°í™” ì™„ë£Œ (Google Sheets):', questions.length + 'ê°œ');
                        if (newQuestions.length > 0) {
                            console.log(`ğŸ“¬ ìƒˆ ì§ˆë¬¸ ${newQuestions.length}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                    } else {
                        questions = [];
                        localStorage.setItem('questions', JSON.stringify(questions));
                        console.log('â“ ì§ˆë¬¸: Google Sheetsì— ë°ì´í„° ì—†ìŒ');
                    }
                } else {
                    console.log('â“ ì§ˆë¬¸: Google Sheets ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                }

                // ìº˜ë¦°ë” ë™ê¸°í™”
                const sheetsCalendar = await loadFromGoogleSheets('getCalendar');
                if (sheetsCalendar !== null) {
                    if (sheetsCalendar.length > 0) {
                        calendar = sheetsCalendar;
                        localStorage.setItem('calendar', JSON.stringify(calendar));
                        console.log('ğŸ“… ìº˜ë¦°ë” ë™ê¸°í™” ì™„ë£Œ:', calendar.length + 'ê°œ');
                    } else {
                        calendar = [];
                        localStorage.setItem('calendar', JSON.stringify(calendar));
                    }
                }

                // ì‚¬ìš©ì ë™ê¸°í™” - Google Sheetsì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ìì™€ ë¡œì»¬ ì‚¬ìš©ì ë³‘í•©
                const sheetsUsers = await loadFromGoogleSheets('getUsers');
                if (sheetsUsers !== null) {
                    if (sheetsUsers.length > 0) {
                        const beforeCount = users.length;

                        // êµì‚¬ ê³„ì •ì„ ë¨¼ì € ë³´ì¡´ (ë¡œì»¬ì— ìˆëŠ” êµì‚¬ ê³„ì •)
                        const teacherAccounts = users.filter(u => u.role === 'teacher');
                        const sheetsUserIds = new Set(sheetsUsers.map(u => u.id));

                        // Google Sheetsì˜ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³‘í•© (êµì‚¬ ì œì™¸)
                        const nonTeacherSheetsUsers = sheetsUsers.filter(u => u.role !== 'teacher');
                        const existingIds = users.map(u => u.id);

                        nonTeacherSheetsUsers.forEach(sheetUser => {
                            const existingIndex = users.findIndex(u => u.id === sheetUser.id);
                            if (existingIndex >= 0) {
                                // ê¸°ì¡´ ì‚¬ìš©ì ì—…ë°ì´íŠ¸ (statusëŠ” Firebase ë°ì´í„° ìš°ì„ , ë‹¨ ë¡œì»¬ì´ pendingì´ë©´ ìœ ì§€)
                                const oldStatus = users[existingIndex].status;
                                // status ì—…ë°ì´íŠ¸: Firebaseì— ëª…ì‹œì  statusê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¡œì»¬ status ìœ ì§€
                                const newStatus = sheetUser.status || users[existingIndex].status;
                                users[existingIndex] = {
                                    ...users[existingIndex],
                                    ...sheetUser,
                                    status: newStatus // ëª…ì‹œì ìœ¼ë¡œ status ì„¤ì •
                                };
                                // ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ (ì˜ˆ: pending -> active) ì•Œë¦¼
                                if (oldStatus === 'pending' && newStatus === 'active') {
                                    console.log('âœ… ìƒˆ íšŒì›ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤:', sheetUser.name);
                                    if (currentUser && currentUser.role === 'teacher') {
                                        alert(`âœ… íšŒì› ìŠ¹ì¸ ì™„ë£Œ: ${sheetUser.name} (${sheetUser.role === 'student' ? 'í•™ìƒ' : 'í•™ë¶€ëª¨'})`);
                                    }
                                }
                            } else {
                                // ìƒˆ ì‚¬ìš©ì ì¶”ê°€ (íšŒì›ê°€ì…) - statusê°€ ì—†ìœ¼ë©´ pendingìœ¼ë¡œ ì„¤ì •
                                const newUser = {
                                    ...sheetUser,
                                    status: sheetUser.status || 'pending'
                                };
                                users.push(newUser);
                                console.log('ğŸ‘¤ ìƒˆ íšŒì›ê°€ì…:', sheetUser.name, '(status:', newUser.status + ')');
                                // ê´€ë¦¬ì(êµì‚¬)ì—ê²Œ ì•Œë¦¼ (pending ìƒíƒœì¼ ë•Œë§Œ)
                                if (newUser.status === 'pending' && currentUser && currentUser.role === 'teacher') {
                                    alert(`ğŸ“¬ ìƒˆ íšŒì›ê°€ì…: ${sheetUser.name} (${sheetUser.role === 'student' ? 'í•™ìƒ' : 'í•™ë¶€ëª¨'})\n\nâ³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.`);
                                }
                            }
                        });

                        // êµì‚¬ ê³„ì • ë³´ì¡´ (Firebaseì— ì—†ì–´ë„ ë¡œì»¬ êµì‚¬ ê³„ì • ìœ ì§€)
                        teacherAccounts.forEach(teacher => {
                            if (!sheetsUserIds.has(teacher.id)) {
                                // Firebaseì— êµì‚¬ ê³„ì •ì´ ì—†ìœ¼ë©´ ë¡œì»¬ êµì‚¬ ê³„ì • ì¶”ê°€
                                const existingTeacherIndex = users.findIndex(u => u.id === teacher.id);
                                if (existingTeacherIndex === -1) {
                                    users.push(teacher);
                                    console.log('âœ… êµì‚¬ ê³„ì • ë³´ì¡´:', teacher.userId);
                                }
                            } else {
                                // Firebaseì— êµì‚¬ ê³„ì •ì´ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ëŠ” ë¡œì»¬ ê²ƒì„ ìœ ì§€
                                const firebaseTeacherIndex = users.findIndex(u => u.id === teacher.id && u.role === 'teacher');
                                if (firebaseTeacherIndex >= 0 && users[firebaseTeacherIndex].password !== teacher.password) {
                                    users[firebaseTeacherIndex].password = teacher.password;
                                    console.log('âœ… êµì‚¬ ê³„ì • ë¹„ë°€ë²ˆí˜¸ ë³´ì¡´:', teacher.userId);
                                }
                            }
                        });

                        localStorage.setItem('users', JSON.stringify(users));
                        const afterCount = users.length;
                        if (afterCount > beforeCount) {
                            console.log(`ğŸ‘¥ ìƒˆ íšŒì› ${afterCount - beforeCount}ëª…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                        console.log('ğŸ‘¥ ì‚¬ìš©ì ë™ê¸°í™” ì™„ë£Œ (Google Sheets):', users.length + 'ëª…');
                        ensureDefaultTeacherAccount();
                    } else {
                        console.log('ğŸ‘¥ ì‚¬ìš©ì: Google Sheetsì— ë°ì´í„° ì—†ìŒ');
                    }
                } else {
                    console.log('ğŸ‘¥ ì‚¬ìš©ì: Google Sheets ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                }

                // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                if (currentSection === 'dashboard') {
                    updateDashboard();
                } else if (currentSection === 'announcements') {
                    loadAnnouncements();
                } else if (currentSection === 'questions') {
                    loadQuestions();
                } else if (currentSection === 'users') {
                    loadUserManagement(); // íšŒì› ê´€ë¦¬ í™”ë©´ë„ ìƒˆë¡œê³ ì¹¨
                }

                console.log('ğŸ‰ Google Sheets ë™ê¸°í™” ì™„ë£Œ!');

            } catch (error) {
                console.error('âŒ Google Sheets ë™ê¸°í™” ì‹¤íŒ¨:', error);
                console.log('ë¡œì»¬ ë°ì´í„°ë¥¼ ê³„ì† ì‚¬ìš©í•©ë‹ˆë‹¤.');
            }
        }

        // Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        let firebaseListeners = [];

        function setupFirebaseRealtimeListeners() {
            if (!firebaseEnabled || !firestore) {
                console.warn('âš ï¸ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            removeFirebaseRealtimeListeners();

            try {
                console.log('ğŸ”„ Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘...');

                // ê³µì§€ì‚¬í•­ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
                const announcementsListener = firestore.collection('announcements')
                    .orderBy('date', 'desc')
                    .onSnapshot((snapshot) => {
                        const newAnnouncements = [];
                        snapshot.forEach((doc) => {
                            newAnnouncements.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });

                        // ê¸°ì¡´ ê³µì§€ì‚¬í•­ê³¼ ë¹„êµí•˜ì—¬ ìƒˆë¡œ ì¶”ê°€ëœ ê²ƒ í™•ì¸
                        const beforeIds = new Set(announcements.map(a => a.id));
                        const newIds = new Set(newAnnouncements.map(a => a.id));
                        const hasNewAnnouncements = newAnnouncements.some(a => !beforeIds.has(a.id));

                        // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                        announcements = newAnnouncements;
                        localStorage.setItem('announcements', JSON.stringify(announcements));

                        console.log('ğŸ”„ ê³µì§€ì‚¬í•­ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', announcements.length + 'ê°œ');

                        // ìƒˆ ê³µì§€ì‚¬í•­ ì•Œë¦¼ (í•™ìƒ/í•™ë¶€ëª¨ì—ê²Œë§Œ)
                        if (hasNewAnnouncements && currentUser &&
                            (currentUser.role === 'student' || currentUser.role === 'parent')) {
                            const newCount = newAnnouncements.filter(a => !beforeIds.has(a.id)).length;
                            console.log(`ğŸ“¢ ìƒˆ ê³µì§€ì‚¬í•­ ${newCount}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            addNotificationForNewAnnouncement();
                        }

                        // í™”ë©´ ì—…ë°ì´íŠ¸
                        if (currentSection === 'announcements') {
                            loadAnnouncements();
                        }
                        if (currentSection === 'dashboard') {
                            updateDashboard();
                        }
                    }, (error) => {
                        console.error('âŒ ê³µì§€ì‚¬í•­ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                    });

                firebaseListeners.push(announcementsListener);

                // ì§ˆë¬¸ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
                const questionsListener = firestore.collection('questions')
                    .orderBy('date', 'desc')
                    .onSnapshot((snapshot) => {
                        const newQuestions = [];
                        snapshot.forEach((doc) => {
                            newQuestions.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });

                        questions = newQuestions;
                        localStorage.setItem('questions', JSON.stringify(questions));

                        console.log('ğŸ”„ ì§ˆë¬¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', questions.length + 'ê°œ');

                        // í™”ë©´ ì—…ë°ì´íŠ¸
                        if (currentSection === 'questions') {
                            loadQuestions();
                        }
                    }, (error) => {
                        console.error('âŒ ì§ˆë¬¸ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                    });

                firebaseListeners.push(questionsListener);

                // ì¼ì • ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
                const calendarListener = firestore.collection('calendar')
                    .orderBy('date', 'asc')
                    .onSnapshot((snapshot) => {
                        const newCalendar = [];
                        snapshot.forEach((doc) => {
                            newCalendar.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });

                        calendar = newCalendar;
                        localStorage.setItem('calendar', JSON.stringify(calendar));

                        console.log('ğŸ”„ ì¼ì • ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', calendar.length + 'ê°œ');

                        // í™”ë©´ ì—…ë°ì´íŠ¸
                        if (currentSection === 'calendar') {
                            generateCalendar();
                        }
                    }, (error) => {
                        console.error('âŒ ì¼ì • ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                    });

                firebaseListeners.push(calendarListener);

                // ì‚¬ìš©ì ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (íšŒì›ê°€ì… ìŠ¹ì¸ìš©)
                const usersListener = firestore.collection('users')
                    .onSnapshot((snapshot) => {
                        const newUsers = [];
                        snapshot.forEach((doc) => {
                            newUsers.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });

                        // ê¸°ì¡´ ì‚¬ìš©ìì™€ ë¹„êµí•˜ì—¬ ìƒíƒœ ë³€ê²½ í™•ì¸
                        const beforeUsers = new Map(users.map(u => [u.id, u.status]));
                        const statusChanges = newUsers.filter(u => {
                            const before = beforeUsers.get(u.id);
                            return before && before !== u.status;
                        });

                        // ìƒˆë¡œ ê°€ì…í•œ ì‚¬ìš©ì í™•ì¸ (êµì‚¬ì—ê²Œ ì•Œë¦¼)
                        const beforeIds = new Set(users.map(u => u.id));
                        const newSignups = newUsers.filter(u => !beforeIds.has(u.id) && u.status === 'pending');

                        // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                        users = newUsers;
                        localStorage.setItem('users', JSON.stringify(users));

                        console.log('ğŸ”„ ì‚¬ìš©ì ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', users.length + 'ê°œ');

                        // ìƒˆ íšŒì›ê°€ì… ì•Œë¦¼ (êµì‚¬ì—ê²Œë§Œ)
                        if (newSignups.length > 0 && currentUser && currentUser.role === 'teacher') {
                            console.log(`ğŸ‘¥ ìƒˆ íšŒì›ê°€ì… ${newSignups.length}ëª…`);
                            newSignups.forEach(user => {
                                const roleName = user.role === 'student' ? 'í•™ìƒ' : 'í•™ë¶€ëª¨';
                                console.log(`ğŸ“¢ ${roleName} ${user.name}ë‹˜ì´ íšŒì›ê°€ì…ì„ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤.`);
                            });

                            // ë¸Œë¼ìš°ì € ì•Œë¦¼
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('ìƒˆ íšŒì›ê°€ì… ì‹ ì²­', {
                                    body: `${newSignups.length}ëª…ì˜ íšŒì›ê°€ì… ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.`,
                                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjNjY3ZWVhIiByeD0iMjQiLz4KPHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeD0iMzYiIHk9IjM2IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KICA8cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptNSAxNkg3di00aDEwdjR6bTAtNkg3VjhIMTd2NHoiLz4KPC9zdmc+Cjwvc3ZnPgo='
                                });
                            }
                        }

                        // ìŠ¹ì¸ ìƒíƒœ ë³€ê²½ ì•Œë¦¼ (í•´ë‹¹ ì‚¬ìš©ìì—ê²Œë§Œ)
                        if (statusChanges.length > 0 && currentUser) {
                            statusChanges.forEach(user => {
                                if (user.id === currentUser.id) {
                                    if (user.status === 'approved') {
                                        alert('ğŸ‰ íšŒì›ê°€ì…ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                                        // ìŠ¹ì¸ëœ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                                        currentUser.status = 'approved';
                                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                                    } else if (user.status === 'rejected') {
                                        alert('âŒ íšŒì›ê°€ì…ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìì„¸í•œ ì‚¬í•­ì€ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                                        // ê±°ë¶€ëœ ê²½ìš° ë¡œê·¸ì•„ì›ƒ
                                        logout();
                                    }
                                }
                            });
                        }

                        // í™”ë©´ ì—…ë°ì´íŠ¸
                        if (currentSection === 'management') {
                            loadUserManagement();
                        }
                    }, (error) => {
                        console.error('âŒ ì‚¬ìš©ì ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                    });

                firebaseListeners.push(usersListener);


                console.log('âœ… Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');

            } catch (error) {
                console.error('âŒ Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨:', error);
            }
        }

        function removeFirebaseRealtimeListeners() {
            firebaseListeners.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            firebaseListeners = [];
            console.log('ğŸ›‘ Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•´ì œ ì™„ë£Œ');
        }

        // ì£¼ê¸°ì  ìë™ ë™ê¸°í™” (30ì´ˆë§ˆë‹¤) - ë°±ì—…ìš© (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìš°ì„ )
        let syncInterval = null;

        function startAutoSync() {
            // Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ìš°ì„ )
            setupFirebaseRealtimeListeners();

            // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì œê±°
            if (syncInterval) {
                clearInterval(syncInterval);
            }

            // 30ì´ˆë§ˆë‹¤ ìë™ ë™ê¸°í™” (ë°±ì—…ìš© - ë¦¬ìŠ¤ë„ˆê°€ ì‹¤íŒ¨í•œ ê²½ìš° ëŒ€ë¹„)
            syncInterval = setInterval(async () => {
                if (isLoggedIn && firebaseEnabled) {
                    console.log('ğŸ”„ ìë™ ë™ê¸°í™” ì‹¤í–‰... (ë°±ì—…)');
                    await syncWithGoogleSheets();
                }
            }, 30000); // 30ì´ˆë§ˆë‹¤

            console.log('âœ… ìë™ ë™ê¸°í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ + 30ì´ˆ ê°„ê²© ë°±ì—…)');
        }

        function stopAutoSync() {
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            removeFirebaseRealtimeListeners();

            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            console.log('â¸ï¸ ìë™ ë™ê¸°í™”ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testGoogleSheetsConnection() {
            if (!firebaseEnabled || !firestore) {
                alert('âŒ Firebaseê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const testDocRef = firestore.collection('meta').doc('connection-test');
                await testDocRef.set({ timestamp: new Date().toISOString() });
                const snapshot = await testDocRef.get();

                if (snapshot.exists) {
                    alert('ğŸ‰ Firebase ì—°ê²°ì´ ì •ìƒì…ë‹ˆë‹¤!');
                    console.log('ì—°ê²° ì„±ê³µ:', snapshot.data());
                } else {
                    throw new Error('í…ŒìŠ¤íŠ¸ ë¬¸ì„œë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('âŒ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
                console.error('ì—°ê²° ì˜¤ë¥˜:', error);
            }
        }

    </script>
</body>

</html>